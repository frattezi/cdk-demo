"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fc = require("fast-check");
const statement_1 = require("../../lib/iam/statement");
test('can parse all positive fields', () => {
    const statement = new statement_1.Statement({
        Sid: 'Sid',
        Effect: 'Allow',
        Resource: ['resource'],
        Action: ['action'],
        Principal: [{ AWS: 'arn' }],
        Condition: { StringEquals: { 'Amzn-This': 'That' } },
    });
    expect(statement.sid).toEqual('Sid');
    expect(statement.effect).toEqual('Allow');
    expect(statement.resources.values).toEqual(['resource']);
    expect(statement.actions.values).toEqual(['action']);
    expect(statement.principals.values).toEqual(['AWS:arn']);
    expect(statement.condition).toEqual({ StringEquals: { 'Amzn-This': 'That' } });
    expect(statement.resources.not).toBe(false);
    expect(statement.actions.not).toBe(false);
    expect(statement.principals.not).toBe(false);
});
test('parses strings as singleton lists', () => {
    const statement = new statement_1.Statement({
        Resource: 'resource',
    });
    expect(statement.resources.values).toEqual(['resource']);
});
test('correctly parses NotFields', () => {
    const statement = new statement_1.Statement({
        NotResource: ['resource'],
        NotAction: ['action'],
        NotPrincipal: [{ AWS: 'arn' }],
    });
    expect(statement.resources.not).toBe(true);
    expect(statement.actions.not).toBe(true);
    expect(statement.principals.not).toBe(true);
});
test('parse all LambdaPermission fields', () => {
    const statement = statement_1.parseLambdaPermission({
        Action: 'lambda:CallMeMaybe',
        FunctionName: 'Function',
        Principal: '*',
        SourceAccount: '123456789012',
        SourceArn: 'arn',
    });
    expect(statement.actions.values).toEqual(['lambda:CallMeMaybe']);
    expect(statement.resources.values).toEqual(['Function']);
    expect(statement.principals.values).toEqual(['*']);
    expect(statement.condition).toEqual({
        ArnLike: { 'AWS:SourceArn': 'arn' },
        StringEquals: { 'AWS:SourceAccount': '123456789012' },
    });
});
test('parse lambda eventsourcetoken', () => {
    const statement = statement_1.parseLambdaPermission({
        Action: 'lambda:CallMeMaybe',
        FunctionName: 'Function',
        EventSourceToken: 'token',
        Principal: '*',
    });
    expect(statement.condition).toEqual({
        StringEquals: { 'lambda:EventSourceToken': 'token' },
    });
});
test('stringify complex condition', () => {
    // WHEN
    const stringified = statement_1.renderCondition({
        StringEquals: { 'AWS:SourceAccount': '${AWS::AccountId}' },
        ArnLike: { 'AWS:SourceArn': '${MyBucket.Arn}' },
    }).split('\n');
    // THEN
    expect(stringified).toEqual([
        '"StringEquals": {',
        '  "AWS:SourceAccount": "${AWS::AccountId}"',
        '},',
        '"ArnLike": {',
        '  "AWS:SourceArn": "${MyBucket.Arn}"',
        '}',
    ]);
});
test('an Allow statement with a NotPrincipal is negative', () => {
    // WHEN
    const statement = new statement_1.Statement({
        Effect: 'Allow',
        Resource: 'resource',
        NotPrincipal: { AWS: 'me' },
    });
    // THEN
    expect(statement.isNegativeStatement).toBe(true);
});
test('a Deny statement with a NotPrincipal is positive', () => {
    // In effect, this is a roundabout way of saying only the given Principal
    // should be allowed ("everyone who's not me can't do this").
    // WHEN
    const statement = new statement_1.Statement({
        Effect: 'Deny',
        Resource: 'resource',
        NotPrincipal: { AWS: 'me' },
    });
    // THEN
    expect(statement.isNegativeStatement).toBe(false);
});
test('equality is reflexive', () => {
    fc.assert(fc.property(arbitraryStatement, (statement) => {
        return new statement_1.Statement(statement).equal(new statement_1.Statement(statement));
    }));
});
test('equality is symmetric', () => {
    fc.assert(fc.property(twoArbitraryStatements, (s) => {
        const a = new statement_1.Statement(s.statement1);
        const b = new statement_1.Statement(s.statement2);
        fc.pre(a.equal(b));
        return b.equal(a);
    }));
});
// We should be testing transitivity as well but it's too much code to generate
// arbitraries that satisfy the precondition enough times to be useful.
const arbitraryResource = fc.oneof(fc.constantFrom('*', 'arn:resource'));
const arbitraryAction = fc.constantFrom('*', 's3:*', 's3:GetObject', 's3:PutObject');
const arbitraryPrincipal = fc.oneof(fc.constant(undefined), fc.constant('*'), fc.record({ AWS: fc.oneof(fc.string(), fc.constant('*')) }), fc.record({ Service: fc.string() }), fc.record({ Federated: fc.string() }));
const arbitraryCondition = fc.oneof(fc.constant(undefined), fc.constant({ StringEquals: { Key: 'Value' } }), fc.constant({ StringEquals: { Key: 'Value' }, NumberEquals: { Key: 5 } }));
const arbitraryStatement = fc.record({
    Sid: fc.oneof(fc.string(), fc.constant(undefined)),
    Effect: fc.constantFrom('Allow', 'Deny'),
    Resource: fc.array(arbitraryResource, 0, 2),
    NotResource: fc.boolean(),
    Action: fc.array(arbitraryAction, 1, 2),
    NotAction: fc.boolean(),
    Principal: fc.array(arbitraryPrincipal, 0, 2),
    NotPrincipal: fc.boolean(),
    Condition: arbitraryCondition,
}).map(record => {
    // This map() that shuffles keys is the easiest way to create variation between Action/NotAction etc.
    makeNot(record, 'Resource', 'NotResource');
    makeNot(record, 'Action', 'NotAction');
    makeNot(record, 'Principal', 'NotPrincipal');
    return record;
});
function makeNot(obj, key, notKey) {
    if (obj[notKey]) {
        obj[notKey] = obj[key];
        delete obj[key];
    }
    else {
        delete obj[notKey];
    }
}
/**
 * Two statements where one is a modification of the other
 *
 * This is to generate two statements that have a higher chance of being similar
 * than generating two arbitrary statements independently.
 */
const twoArbitraryStatements = fc.record({
    statement1: arbitraryStatement,
    statement2: arbitraryStatement,
    copySid: fc.boolean(),
    copyEffect: fc.boolean(),
    copyResource: fc.boolean(),
    copyAction: fc.boolean(),
    copyPrincipal: fc.boolean(),
    copyCondition: fc.boolean(),
}).map(op => {
    const original = op.statement1;
    const modified = Object.create(original, {});
    if (op.copySid) {
        modified.Sid = op.statement2.Sid;
    }
    if (op.copyEffect) {
        modified.Effect = op.statement2.Effect;
    }
    if (op.copyResource) {
        modified.Resource = op.statement2.Resource;
        modified.NotResource = op.statement2.NotResource;
    }
    if (op.copyAction) {
        modified.Action = op.statement2.Action;
        modified.NotAction = op.statement2.NotAction;
    }
    if (op.copyPrincipal) {
        modified.Principal = op.statement2.Principal;
        modified.NotPrincipal = op.statement2.NotPrincipal;
    }
    if (op.copyCondition) {
        modified.Condition = op.statement2.Condition;
    }
    return { statement1: original, statement2: modified };
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVtZW50LnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzdGF0ZW1lbnQudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlDQUFpQztBQUNqQyx1REFBNEY7QUFFNUYsSUFBSSxDQUFDLCtCQUErQixFQUFFLEdBQUcsRUFBRTtJQUN6QyxNQUFNLFNBQVMsR0FBRyxJQUFJLHFCQUFTLENBQUM7UUFDOUIsR0FBRyxFQUFFLEtBQUs7UUFDVixNQUFNLEVBQUUsT0FBTztRQUNmLFFBQVEsRUFBRSxDQUFDLFVBQVUsQ0FBQztRQUN0QixNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUM7UUFDbEIsU0FBUyxFQUFFLENBQUMsRUFBQyxHQUFHLEVBQUUsS0FBSyxFQUFDLENBQUM7UUFDekIsU0FBUyxFQUFFLEVBQUUsWUFBWSxFQUFFLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxFQUFFO0tBQ3JELENBQUMsQ0FBQztJQUVILE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3JDLE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7SUFDekQsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUNyRCxNQUFNLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0lBQ3pELE1BQU0sQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsWUFBWSxFQUFFLEVB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QzVHLElBQUksRUFBRSxDQUFDLGFBQWEsRUFBRTtRQUFFLFFBQVEsQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUM7UUFBQyxRQUFRLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDO0tBQUU7SUFDM0gsSUFBSSxFQUFFLENBQUMsYUFBYSxFQUFFO1FBQUUsUUFBUSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQztLQUFFO0lBRXZFLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsQ0FBQztBQUN4RCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZjIGZyb20gJ2Zhc3QtY2hlY2snO1xuaW1wb3J0IHsgcGFyc2VMYW1iZGFQZXJtaXNzaW9uLCByZW5kZXJDb25kaXRpb24sIFN0YXRlbWVudCB9IGZyb20gJy4uLy4uL2xpYi9pYW0vc3RhdGVtZW50JztcblxudGVzdCgnY2FuIHBhcnNlIGFsbCBwb3NpdGl2ZSBmaWVsZHMnLCAoKSA9PiB7XG4gIGNvbnN0IHN0YXRlbWVudCA9IG5ldyBTdGF0ZW1lbnQoe1xuICAgIFNpZDogJ1NpZCcsXG4gICAgRWZmZWN0OiAnQWxsb3cnLFxuICAgIFJlc291cmNlOiBbJ3Jlc291cmNlJ10sXG4gICAgQWN0aW9uOiBbJ2FjdGlvbiddLFxuICAgIFByaW5jaXBhbDogW3tBV1M6ICdhcm4nfV0sXG4gICAgQ29uZGl0aW9uOiB7IFN0cmluZ0VxdWFsczogeyAnQW16bi1UaGlzJzogJ1RoYXQnIH0gfSxcbiAgfSk7XG5cbiAgZXhwZWN0KHN0YXRlbWVudC5zaWQpLnRvRXF1YWwoJ1NpZCcpO1xuICBleHBlY3Qoc3RhdGVtZW50LmVmZmVjdCkudG9FcXVhbCgnQWxsb3cnKTtcbiAgZXhwZWN0KHN0YXRlbWVudC5yZXNvdXJjZXMudmFsdWVzKS50b0VxdWFsKFsncmVzb3VyY2UnXSk7XG4gIGV4cGVjdChzdGF0ZW1lbnQuYWN0aW9ucy52YWx1ZXMpLnRvRXF1YWwoWydhY3Rpb24nXSk7XG4gIGV4cGVjdChzdGF0ZW1lbnQucHJpbmNpcGFscy52YWx1ZXMpLnRvRXF1YWwoWydBV1M6YXJuJ10pO1xuICBleHBlY3Qoc3RhdGVtZW50LmNvbmRpdGlvbikudG9FcXVhbCh7IFN0cmluZ0VxdWFsczogeyAnQW16bi1UaGlzJzogJ1RoYXQnIH0gfSk7XG5cbiAgZXhwZWN0KHN0YXRlbWVudC5yZXNvdXJjZXMubm90KS50b0JlKGZhbHNlKTtcbiAgZXhwZWN0KHN0YXRlbWVudC5hY3Rpb25zLm5vdCkudG9CZShmYWxzZSk7XG4gIGV4cGVjdChzdGF0ZW1lbnQucHJpbmNpcGFscy5ub3QpLnRvQmUoZmFsc2UpO1xufSk7XG5cbnRlc3QoJ3BhcnNlcyBzdHJpbmdzIGFzIHNpbmdsZXRvbiBsaXN0cycsICgpID0+IHtcbiAgY29uc3Qgc3RhdGVtZW50ID0gbmV3IFN0YXRlbWVudCh7XG4gICAgUmVzb3VyY2U6ICdyZXNvdXJjZScsXG4gIH0pO1xuXG4gIGV4cGVjdChzdGF0ZW1lbnQucmVzb3VyY2VzLnZhbHVlcykudG9FcXVhbChbJ3Jlc291cmNlJ10pO1xufSk7XG5cbnRlc3QoJ2NvcnJlY3RseSBwYXJzZXMgTm90RmllbGRzJywgKCkgPT4ge1xuICBjb25zdCBzdGF0ZW1lbnQgPSBuZXcgU3RhdGVtZW50KHtcbiAgICBOb3RSZXNvdXJjZTogWydyZXNvdXJjZSddLFxuICAgIE5vdEFjdGlvbjogWydhY3Rpb24nXSxcbiAgICBOb3RQcmluY2lwYWw6IFt7QVdTOiAnYXJuJ31dLFxuICB9KTtcblxuICBleHBlY3Qoc3RhdGVtZW50LnJlc291cmNlcy5ub3QpLnRvQmUodHJ1ZSk7XG4gIGV4cGVjdChzdGF0ZW1lbnQuYWN0aW9ucy5ub3QpLnRvQmUodHJ1ZSk7XG4gIGV4cGVjdChzdGF0ZW1lbnQucHJpbmNpcGFscy5ub3QpLnRvQmUodHJ1ZSk7XG59KTtcblxudGVzdCgncGFyc2UgYWxsIExhbWJkYVBlcm1pc3Npb24gZmllbGRzJywgKCkgPT4ge1xuICBjb25zdCBzdGF0ZW1lbnQgPSBwYXJzZUxhbWJkYVBlcm1pc3Npb24oe1xuICAgIEFjdGlvbjogJ2xhbWJkYTpDYWxsTWVNYXliZScsXG4gICAgRnVuY3Rpb25OYW1lOiAnRnVuY3Rpb24nLFxuICAgIFByaW5jaXBhbDogJyonLFxuICAgIFNvdXJjZUFjY291bnQ6ICcxMjM0NTY3ODkwMTInLFxuICAgIFNvdXJjZUFybjogJ2FybicsXG4gIH0pO1xuXG4gIGV4cGVjdChzdGF0ZW1lbnQuYWN0aW9ucy52YWx1ZXMpLnRvRXF1YWwoWydsYW1iZGE6Q2FsbE1lTWF5YmUnXSk7XG4gIGV4cGVjdChzdGF0ZW1lbnQucmVzb3VyY2VzLnZhbHVlcykudG9FcXVhbChbJ0Z1bmN0aW9uJ10pO1xuICBleHBlY3Qoc3RhdGVtZW50LnByaW5jaXBhbHMudmFsdWVzKS50b0VxdWFsKFsnKiddKTtcbiAgZXhwZWN0KHN0YXRlbWVudC5jb25kaXRpb24pLnRvRXF1YWwoe1xuICAgIEFybkxpa2U6IHsgJ0FXUzpTb3VyY2VBcm4nOiAnYXJuJyB9LFxuICAgIFN0cmluZ0VxdWFsczogeyAnQVdTOlNvdXJjZUFjY291bnQnOiAnMTIzNDU2Nzg5MDEyJyB9LFxuICB9KTtcbn0pO1xuXG50ZXN0KCdwYXJzZSBsYW1iZGEgZXZlbnRzb3VyY2V0b2tlbicsICgpID0+IHtcbiAgY29uc3Qgc3RhdGVtZW50ID0gcGFyc2VMYW1iZGFQZXJtaXNzaW9uKHtcbiAgICBBY3Rpb246ICdsYW1iZGE6Q2FsbE1lTWF5YmUnLFxuICAgIEZ1bmN0aW9uTmFtZTogJ0Z1bmN0aW9uJyxcbiAgICBFdmVudFNvdXJjZVRva2VuOiAndG9rZW4nLFxuICAgIFByaW5jaXBhbDogJyonLFxuICB9KTtcblxuICBleHBlY3Qoc3RhdGVtZW50LmNvbmRpdGlvbikudG9FcXVhbCh7XG4gICAgU3RyaW5nRXF1YWxzOiB7ICdsYW1iZGE6RXZlbnRTb3VyY2VUb2tlbic6ICd0b2tlbicgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnc3RyaW5naWZ5IGNvbXBsZXggY29uZGl0aW9uJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIGNvbnN0IHN0cmluZ2lmaWVkID0gcmVuZGVyQ29uZGl0aW9uKHtcbiAgICBTdHJpbmdFcXVhbHM6IHsgJ0FXUzpTb3VyY2VBY2NvdW50JzogJyR7QVdTOjpBY2NvdW50SWR9JyB9LFxuICAgIEFybkxpa2U6IHsgJ0FXUzpTb3VyY2VBcm4nOiAnJHtNeUJ1Y2tldC5Bcm59JyB9LFxuICB9KS5zcGxpdCgnXFxuJyk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3Qoc3RyaW5naWZpZWQpLnRvRXF1YWwoW1xuICAgICdcIlN0cmluZ0VxdWFsc1wiOiB7JyxcbiAgICAnICBcIkFXUzpTb3VyY2VBY2NvdW50XCI6IFwiJHtBV1M6OkFjY291bnRJZH1cIicsXG4gICAgJ30sJyxcbiAgICAnXCJBcm5MaWtlXCI6IHsnLFxuICAgICcgIFwiQVdTOlNvdXJjZUFyblwiOiBcIiR7TXlCdWNrZXQuQXJufVwiJyxcbiAgICAnfScsXG4gIF0pO1xufSk7XG5cbnRlc3QoJ2FuIEFsbG93IHN0YXRlbWVudCB3aXRoIGEgTm90UHJpbmNpcGFsIGlzIG5lZ2F0aXZlJywgKCkgPT4ge1xuICAvLyBXSEVOXG4gIGNvbnN0IHN0YXRlbWVudCA9IG5ldyBTdGF0ZW1lbnQoe1xuICAgIEVmZmVjdDogJ0FsbG93JyxcbiAgICBSZXNvdXJjZTogJ3Jlc291cmNlJyxcbiAgICBOb3RQcmluY2lwYWw6IHsgQVdTOiAnbWUnIH0sXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHN0YXRlbWVudC5pc05lZ2F0aXZlU3RhdGVtZW50KS50b0JlKHRydWUpO1xufSk7XG5cbnRlc3QoJ2EgRGVueSBzdGF0ZW1lbnQgd2l0aCBhIE5vdFByaW5jaXBhbCBpcyBwb3NpdGl2ZScsICgpID0+IHtcbiAgLy8gSW4gZWZmZWN0LCB0aGlzIGlzIGEgcm91bmRhYm91dCB3YXkgb2Ygc2F5aW5nIG9ubHkgdGhlIGdpdmVuIFByaW5jaXBhbFxuICAvLyBzaG91bGQgYmUgYWxsb3dlZCAoXCJldmVyeW9uZSB3aG8ncyBub3QgbWUgY2FuJ3QgZG8gdGhpc1wiKS5cblxuICAvLyBXSEVOXG4gIGNvbnN0IHN0YXRlbWVudCA9IG5ldyBTdGF0ZW1lbnQoe1xuICAgIEVmZmVjdDogJ0RlbnknLFxuICAgIFJlc291cmNlOiAncmVzb3VyY2UnLFxuICAgIE5vdFByaW5jaXBhbDogeyBBV1M6ICdtZScgfSxcbiAgfSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3Qoc3RhdGVtZW50LmlzTmVnYXRpdmVTdGF0ZW1lbnQpLnRvQmUoZmFsc2UpO1xufSk7XG5cbnRlc3QoJ2VxdWFsaXR5IGlzIHJlZmxleGl2ZScsICgpID0+IHtcbiAgZmMuYXNzZXJ0KGZjLnByb3BlcnR5KFxuICAgIGFyYml0cmFyeVN0YXRlbWVudCwgKHN0YXRlbWVudCkgPT4ge1xuICAgICAgcmV0dXJuIG5ldyBTdGF0ZW1lbnQoc3RhdGVtZW50KS5lcXVhbChuZXcgU3RhdGVtZW50KHN0YXRlbWVudCkpO1xuICAgIH0sXG4gICkpO1xufSk7XG5cbnRlc3QoJ2VxdWFsaXR5IGlzIHN5bW1ldHJpYycsICgpID0+IHtcbiAgZmMuYXNzZXJ0KGZjLnByb3BlcnR5KFxuICAgIHR3b0FyYml0cmFyeVN0YXRlbWVudHMsIChzKSA9PiB7XG4gICAgICBjb25zdCBhID0gbmV3IFN0YXRlbWVudChzLnN0YXRlbWVudDEpO1xuICAgICAgY29uc3QgYiA9IG5ldyBTdGF0ZW1lbnQocy5zdGF0ZW1lbnQyKTtcblxuICAgICAgZmMucHJlKGEuZXF1YWwoYikpO1xuICAgICAgcmV0dXJuIGIuZXF1YWwoYSk7XG4gICAgfSxcbiAgKSk7XG59KTtcblxuLy8gV2Ugc2hvdWxkIGJlIHRlc3RpbmcgdHJhbnNpdGl2aXR5IGFzIHdlbGwgYnV0IGl0J3MgdG9vIG11Y2ggY29kZSB0byBnZW5lcmF0ZVxuLy8gYXJiaXRyYXJpZXMgdGhhdCBzYXRpc2Z5IHRoZSBwcmVjb25kaXRpb24gZW5vdWdoIHRpbWVzIHRvIGJlIHVzZWZ1bC5cblxuY29uc3QgYXJiaXRyYXJ5UmVzb3VyY2UgPSBmYy5vbmVvZihmYy5jb25zdGFudEZyb20oJyonLCAnYXJuOnJlc291cmNlJykpO1xuY29uc3QgYXJiaXRyYXJ5QWN0aW9uID0gZmMuY29uc3RhbnRGcm9tKCcqJywgJ3MzOionLCAnczM6R2V0T2JqZWN0JywgJ3MzOlB1dE9iamVjdCcpO1xuY29uc3QgYXJiaXRyYXJ5UHJpbmNpcGFsID0gZmMub25lb2Y8YW55PihcbiAgZmMuY29uc3RhbnQodW5kZWZpbmVkKSxcbiAgZmMuY29uc3RhbnQoJyonKSxcbiAgZmMucmVjb3JkKHsgQVdTOiBmYy5vbmVvZihmYy5zdHJpbmcoKSwgZmMuY29uc3RhbnQoJyonKSkgfSksXG4gIGZjLnJlY29yZCh7IFNlcnZpY2U6IGZjLnN0cmluZygpIH0pLFxuICBmYy5yZWNvcmQoeyBGZWRlcmF0ZWQ6IGZjLnN0cmluZygpIH0pLFxuKTtcbmNvbnN0IGFyYml0cmFyeUNvbmRpdGlvbiA9IGZjLm9uZW9mKFxuICBmYy5jb25zdGFudCh1bmRlZmluZWQpLFxuICBmYy5jb25zdGFudCh7IFN0cmluZ0VxdWFsczogeyBLZXk6ICdWYWx1ZScgfX0pLFxuICBmYy5jb25zdGFudCh7IFN0cmluZ0VxdWFsczogeyBLZXk6ICdWYWx1ZScgfSwgTnVtYmVyRXF1YWxzOiB7IEtleTogNSB9fSksXG4pO1xuXG5jb25zdCBhcmJpdHJhcnlTdGF0ZW1lbnQgPSBmYy5yZWNvcmQoe1xuICBTaWQ6IGZjLm9uZW9mKGZjLnN0cmluZygpLCBmYy5jb25zdGFudCh1bmRlZmluZWQpKSxcbiAgRWZmZWN0OiBmYy5jb25zdGFudEZyb20oJ0FsbG93JywgJ0RlbnknKSxcbiAgUmVzb3VyY2U6IGZjLmFycmF5KGFyYml0cmFyeVJlc291cmNlLCAwLCAyKSxcbiAgTm90UmVzb3VyY2U6IGZjLmJvb2xlYW4oKSxcbiAgQWN0aW9uOiBmYy5hcnJheShhcmJpdHJhcnlBY3Rpb24sIDEsIDIpLFxuICBOb3RBY3Rpb246IGZjLmJvb2xlYW4oKSxcbiAgUHJpbmNpcGFsOiBmYy5hcnJheShhcmJpdHJhcnlQcmluY2lwYWwsIDAsIDIpLFxuICBOb3RQcmluY2lwYWw6IGZjLmJvb2xlYW4oKSxcbiAgQ29uZGl0aW9uOiBhcmJpdHJhcnlDb25kaXRpb24sXG59KS5tYXAocmVjb3JkID0+IHtcbiAgLy8gVGhpcyBtYXAoKSB0aGF0IHNodWZmbGVzIGtleXMgaXMgdGhlIGVhc2llc3Qgd2F5IHRvIGNyZWF0ZSB2YXJpYXRpb24gYmV0d2VlbiBBY3Rpb24vTm90QWN0aW9uIGV0Yy5cbiAgbWFrZU5vdChyZWNvcmQsICdSZXNvdXJjZScsICdOb3RSZXNvdXJjZScpO1xuICBtYWtlTm90KHJlY29yZCwgJ0FjdGlvbicsICdOb3RBY3Rpb24nKTtcbiAgbWFrZU5vdChyZWNvcmQsICdQcmluY2lwYWwnLCAnTm90UHJpbmNpcGFsJyk7XG4gIHJldHVybiByZWNvcmQ7XG59KTtcblxuZnVuY3Rpb24gbWFrZU5vdChvYmo6IGFueSwga2V5OiBzdHJpbmcsIG5vdEtleTogc3RyaW5nKSB7XG4gIGlmIChvYmpbbm90S2V5XSkge1xuICAgIG9ialtub3RLZXldID0gb2JqW2tleV07XG4gICAgZGVsZXRlIG9ialtrZXldO1xuICB9IGVsc2Uge1xuICAgIGRlbGV0ZSBvYmpbbm90S2V5XTtcbiAgfVxufVxuXG4vKipcbiAqIFR3byBzdGF0ZW1lbnRzIHdoZXJlIG9uZSBpcyBhIG1vZGlmaWNhdGlvbiBvZiB0aGUgb3RoZXJcbiAqXG4gKiBUaGlzIGlzIHRvIGdlbmVyYXRlIHR3byBzdGF0ZW1lbnRzIHRoYXQgaGF2ZSBhIGhpZ2hlciBjaGFuY2Ugb2YgYmVpbmcgc2ltaWxhclxuICogdGhhbiBnZW5lcmF0aW5nIHR3byBhcmJpdHJhcnkgc3RhdGVtZW50cyBpbmRlcGVuZGVudGx5LlxuICovXG5jb25zdCB0d29BcmJpdHJhcnlTdGF0ZW1lbnRzID0gZmMucmVjb3JkKHtcbiAgc3RhdGVtZW50MTogYXJiaXRyYXJ5U3RhdGVtZW50LFxuICBzdGF0ZW1lbnQyOiBhcmJpdHJhcnlTdGF0ZW1lbnQsXG4gIGNvcHlTaWQ6IGZjLmJvb2xlYW4oKSxcbiAgY29weUVmZmVjdDogZmMuYm9vbGVhbigpLFxuICBjb3B5UmVzb3VyY2U6IGZjLmJvb2xlYW4oKSxcbiAgY29weUFjdGlvbjogZmMuYm9vbGVhbigpLFxuICBjb3B5UHJpbmNpcGFsOiBmYy5ib29sZWFuKCksXG4gIGNvcHlDb25kaXRpb246IGZjLmJvb2xlYW4oKSxcbn0pLm1hcChvcCA9PiB7XG4gIGNvbnN0IG9yaWdpbmFsID0gb3Auc3RhdGVtZW50MTtcbiAgY29uc3QgbW9kaWZpZWQgPSBPYmplY3QuY3JlYXRlKG9yaWdpbmFsLCB7fSk7XG5cbiAgaWYgKG9wLmNvcHlTaWQpIHsgbW9kaWZpZWQuU2lkID0gb3Auc3RhdGVtZW50Mi5TaWQ7IH1cbiAgaWYgKG9wLmNvcHlFZmZlY3QpIHsgbW9kaWZpZWQuRWZmZWN0ID0gb3Auc3RhdGVtZW50Mi5FZmZlY3Q7IH1cbiAgaWYgKG9wLmNvcHlSZXNvdXJjZSkgeyBtb2RpZmllZC5SZXNvdXJjZSA9IG9wLnN0YXRlbWVudDIuUmVzb3VyY2U7IG1vZGlmaWVkLk5vdFJlc291cmNlID0gb3Auc3RhdGVtZW50Mi5Ob3RSZXNvdXJjZTsgfVxuICBpZiAob3AuY29weUFjdGlvbikgeyBtb2RpZmllZC5BY3Rpb24gPSBvcC5zdGF0ZW1lbnQyLkFjdGlvbjsgbW9kaWZpZWQuTm90QWN0aW9uID0gb3Auc3RhdGVtZW50Mi5Ob3RBY3Rpb247IH1cbiAgaWYgKG9wLmNvcHlQcmluY2lwYWwpIHsgbW9kaWZpZWQuUHJpbmNpcGFsID0gb3Auc3RhdGVtZW50Mi5QcmluY2lwYWw7IG1vZGlmaWVkLk5vdFByaW5jaXBhbCA9IG9wLnN0YXRlbWVudDIuTm90UHJpbmNpcGFsOyB9XG4gIGlmIChvcC5jb3B5Q29uZGl0aW9uKSB7IG1vZGlmaWVkLkNvbmRpdGlvbiA9IG9wLnN0YXRlbWVudDIuQ29uZGl0aW9uOyB9XG5cbiAgcmV0dXJuIHsgc3RhdGVtZW50MTogb3JpZ2luYWwsIHN0YXRlbWVudDI6IG1vZGlmaWVkIH07XG59KTtcbiJdfQ==