"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const url_1 = require("url");
const consts = require("../../lib/provider-framework/runtime/consts");
exports.MOCK_REQUEST = {
    ResponseURL: 'http://pre-signed-S3-url-for-response/path/in/bucket',
    LogicalResourceId: 'MyTestResource',
    RequestId: 'uniqueid-for-this-create-request',
    StackId: 'arn:aws:cloudformation:us-west-2:123456789012:stack/stack-name/guid',
};
exports.MOCK_ON_EVENT_FUNCTION_ARN = 'arn:lambda:user:on:event';
exports.MOCK_IS_COMPLETE_FUNCTION_ARN = 'arn:lambda:user:is:complete';
exports.MOCK_SFN_ARN = 'arn:of:state:machine';
exports.stringifyPayload = true;
function setup() {
    process.env[consts.WAITER_STATE_MACHINE_ARN_ENV] = exports.MOCK_SFN_ARN;
    exports.stringifyPayload = true;
    exports.onEventImplMock = undefined;
    exports.isCompleteImplMock = undefined;
    exports.cfnResponse = {};
    exports.startStateMachineInput = undefined;
}
exports.setup = setup;
async function httpRequestMock(options, body) {
    const responseUrl = url_1.parse(exports.MOCK_REQUEST.ResponseURL);
    expect(options.method).toEqual('PUT');
    expect(options.path).toEqual(responseUrl.path);
    expect(options.hostname).toEqual(responseUrl.hostname);
    const headers = options.headers || {};
    expect(headers['content-length']).toEqual(body.length);
    expect(headers['content-type']).toStrictEqual('');
    exports.cfnResponse = JSON.parse(body);
    if (!exports.cfnResponse) {
        throw new Error('unexpected');
    }
    // we always expect a physical resource id
    expect(exports.cfnResponse.PhysicalResourceId).toBeTruthy();
    // we always expect a reason
    expect(exports.cfnResponse.Reason).toBeTruthy();
    expect(exports.cfnResponse.LogicalResourceId).toEqual(exports.MOCK_REQUEST.LogicalResourceId);
    expect(exports.cfnResponse.RequestId).toEqual(exports.MOCK_REQUEST.RequestId);
    expect(exports.cfnResponse.StackId).toEqual(exports.MOCK_REQUEST.StackId);
    expect(exports.cfnResponse.Status === 'FAILED' || exports.cfnResponse.Status === 'SUCCESS').toBeTruthy();
}
exports.httpRequestMock = httpRequestMock;
async function invokeFunctionMock(req) {
    if (!req.Payload || typeof (req.Payload) !== 'string') {
        throw new Error(`invalid payload of type ${typeof (req.Payload)}}`);
    }
    const input = JSON.parse(req.Payload);
    try {
        let ret;
        switch (req.FunctionName) {
            case exports.MOCK_ON_EVENT_FUNCTION_ARN:
                if (!exports.onEventImplMock) {
                    throw new Error('Trying to trigger "onEvent" but it is not implemented');
                }
                ret = await exports.onEventImplMock(input);
                break;
            case exports.MOCK_IS_COMPLETE_FUNCTION_ARN:
                if (!exports.isCompleteImplMock) {
                    throw new Error('Trying to trigger "isComplete" but it is not implemented');
                }
                ret = await exports.isCompleteImplMock(input);
                break;
            default:
                throw new Error('unknown mock function');
        }
        return {
            Payload: exports.stringifyPayload ? JSON.stringify(ret) : ret,
        };
    }
    catch (e) {
        return {
            FunctionError: 'Unhandled',
            Payload: JSON.stringify({
                errorType: e.name,
                errorMessage: e.message,
                trace: [
                    'AccessDenied: Access Denied',
                    '    at Request.extractError (/var/runtime/node_modules/aws-sdk/lib/services/s3.js:585:35)',
                    '    at Request.callListeners (/var/runtime/node_modules/aws-sdk/lib/sequential_executor.js:106:20)',
                    '    at Request.emit (/var/runtime/node_modules/aws-sdk/lib/sequential_executor.js:78:10)',
                    '    at Request.emit (/var/runtime/node_modules/aws-sdk/lib/request.js:683:14)',
                    '    at Request.transition (/var/runtime/node_modules/aws-sdk/lib/request.js:22:10)',
                    '    at AcceptorStateMachine.runTo (/var/runtime/node_modules/aws-sdk/lib/state_machine.js:14:12)',
                    '    at /var/runtime/node_modules/aws-sdk/lib/state_machine.js:26:10',
                    '    at Request.<anonymous> (/var/runtime/node_modules/aws-sdk/lib/request.js:38:9)',
                    '    at Request.<anonymous> (/var/runtime/node_modules/aws-sdk/lib/request.js:685:12)',
                    '    at Request.callListeners (/var/runtime/node_modules/aws-sdk/lib/sequential_executor.js:116:18)',
                ],
            }),
        };
    }
}
exports.invokeFunctionMock = invokeFunctionMock;
function prepareForExecution() {
    exports.startStateMachineInput = undefined;
    if (exports.onEventImplMock) {
        process.env[consts.USER_ON_EVENT_FUNCTION_ARN_ENV] = exports.MOCK_ON_EVENT_FUNCTION_ARN;
    }
    else {
        delete process.env[consts.USER_ON_EVENT_FUNCTION_ARN_ENV];
    }
    if (exports.isCompleteImplMock) {
        process.env[consts.USER_IS_COMPLETE_FUNCTION_ARN_ENV] = exports.MOCK_IS_COMPLETE_FUNCTION_ARN;
    }
    else {
        delete process.env[consts.USER_IS_COMPLETE_FUNCTION_ARN_ENV];
    }
}
exports.prepareForExecution = prepareForExecution;
async function startExecutionMock(req) {
    exports.startStateMachineInput = req;
    expect(req.stateMachineArn).toEqual(exports.MOCK_SFN_ARN);
    return {
        executionArn: req.stateMachineArn + '/execution',
        startDate: new Date(),
    };
}
exports.startExecutionMock = startExecutionMock;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9ja3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtb2Nrcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZCQUF3QztBQUN4QyxzRUFBc0U7QUFFekQsUUFBQSxZQUFZLEdBQUc7SUFDMUIsV0FBVyxFQUFFLHNEQUFzRDtJQUNuRSxpQkFBaUIsRUFBRSxnQkFBZ0I7SUFDbkMsU0FBUyxFQUFFLGtDQUFrQztJQUM3QyxPQUFPLEVBQUUscUVBQXFFO0NBQy9FLENBQUM7QUFFVyxRQUFBLDBCQUEwQixHQUFHLDBCQUEwQixDQUFDO0FBQ3hELFFBQUEsNkJBQTZCLEdBQUcsNkJBQTZCLENBQUM7QUFDOUQsUUFBQSxZQUFZLEdBQUcsc0JBQXNCLENBQUM7QUFFeEMsUUFBQSxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7QUFNbkMsU0FBZ0IsS0FBSztJQUNuQixPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyw0QkFBNEIsQ0FBQyxHQUFHLG9CQUFZLENBQUM7SUFFaEUsd0JBQWdCLEdBQUcsSUFBSSxDQUFDO0lBQ3hCLHVCQUFlLEdBQUcsU0FBUyxDQUFDO0lBQzVCLDBCQUFrQixHQUFHLFNBQVMsQ0FBQztJQUMvQixtQkFBVyxHQUFHLEVBQVMsQ0FBQztJQUN4Qiw4QkFBc0IsR0FBRyxTQUFTLENBQUM7QUFDckMsQ0FBQztBQVJELHNCQVFDO0FBRU0sS0FBSyxVQUFVLGVBQWUsQ0FBQyxPQUE2QixFQUFFLElBQVk7SUFDL0UsTUFBTSxXQUFXLEdBQUcsV0FBUSxDQUFDLG9CQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7SUFFdkQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdEMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9DLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN2RCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQztJQUN0QyxNQUFNLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3ZELE1BQU0sQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbEQsbUJBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRS9CLElBQUksQ0FBQyxtQkFBVyxFQUFFO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQztLQUFFO0lBRXBELDBDQUEwQztJQUMxQyxNQUFNLENBQUMsbUJBQVcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBRXBELDRCQUE0QjtJQUM1QixNQUFNLENBQUMsbUJBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUV4QyxNQUFNLENBQUMsbUJBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxvQkFBWSxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDOUUsTUFBTSxDQUFDLG1CQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLG9CQUFZLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDOUQsTUFBTSxDQUFDLG1CQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLG9CQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDMUQsTUFBTSxDQUFDLG1CQUFXLENBQUMsTUFBTSxLQUFLLFFBQVEsSUFBSSxtQkFBVyxDQUFDLE1BQU0sS0FBSyxTQUFTLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQztBQUMzRixDQUFDO0FBdkJELDBDQXVCQztBQUVNLEtBQUssVUFBVSxrQkFBa0IsQ0FBQyxHQUFpQztJQUN4RSxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLFFBQVEsRUFBRTtRQUNyRCxNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUNyRTtJQUVELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRXRDLElBQUk7UUFFRixJQUFJLEdBQUcsQ0FBQztRQUNSLFFBQVEsR0FBRyxDQUFDLFlBQVksRUFBRTtZQUN4QixLQUFLLGtDQUEwQjtnQkFDN0IsSUFBSSxDQUFDLHVCQUFlLEVBQUU7b0JBQ3BCLE1BQU0sSUFBSSxLQUFLLENBQUMsdURBQXVELENBQUMsQ0FBQztpQkFDMUU7Z0JBQ0QsR0FBRyxHQUFHLE1BQU0sdUJBQWUsQ0FBQyxLQUFpRCxDQUFDLENBQUM7Z0JBQy9FLE1BQU07WUFFUixLQUFLLHFDQUE2QjtnQkFDaEMsSUFBSSxDQUFDLDBCQUFrQixFQUFFO29CQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLDBEQUEwRCxDQUFDLENBQUM7aUJBQzdFO2dCQUNELEdBQUcsR0FBRyxNQUFNLDBCQUFrQixDQUFDLEtBQW9ELENBQUMsQ0FBQztnQkFDckYsTUFBTTtZQUVSO2dCQUNFLE1BQU0sSUFBSSxLQUFLLENBQUMsdUJBQXVCLENBQUMsQ0FBQztTQUM1QztRQUVELE9BQU87WUFDTCxPQUFPLEVBQUUsd0JBQWdCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUc7U0FDdEQsQ0FBQztLQUNIO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDVixPQUFPO1lBQ0wsYUFBYSxFQUFFLFdBQVc7WUFDMUIsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ3RCLFNBQVMsRUFBRSxDQUFDLENBQUMsSUFBSTtnQkFDakIsWUFBWSxFQUFFLENBQUMsQ0FBQyxPQUFPO2dCQUN2QixLQUFLLEVBQUU7b0JBQ0wsNkJBQTZCO29CQUM3QiwyRkFBMkY7b0JBQzNGLG9HQUFvRztvQkFDcEcsMEZBQTBGO29CQUMxRiwrRUFBK0U7b0JBQy9FLG9GQUFvRjtvQkFDcEYsa0dBQWtHO29CQUNsRyxxRUFBcUU7b0JBQ3JFLG9GQUFvRjtvQkFDcEYsc0ZBQXNGO29CQUN0RixvR0FBb0c7aUJBQ3JHO2FBQ0YsQ0FBQztTQUNILENBQUM7S0FDSDtBQUNILENBQUM7QUF0REQsZ0RBc0RDO0FBRUQsU0FBZ0IsbUJBQW1CO0lBQ2pDLDhCQUFzQixHQUFHLFNBQVMsQ0FBQztJQUVuQyxJQUFJLHVCQUFlLEVBQUU7UUFDbkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsOEJBQThCLENBQUMsR0FBRyxrQ0FBMEIsQ0FBQztLQUNqRjtTQUFNO1FBQ0wsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO0tBQzNEO0lBRUQsSUFBSSwwQkFBa0IsRUFBRTtRQUN0QixPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxpQ0FBaUMsQ0FBQyxHQUFHLHFDQUE2QixDQUFDO0tBQ3ZGO1NBQU07UUFDTCxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLGlDQUFpQyxDQUFDLENBQUM7S0FDOUQ7QUFDSCxDQUFDO0FBZEQsa0RBY0M7QUFFTSxLQUFLLFVBQVUsa0JBQWtCLENBQUMsR0FBMEM7SUFDakYsOEJBQXNCLEdBQUcsR0FBRyxDQUFDO0lBQzdCLE1BQU0sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUMsT0FBTyxDQUFDLG9CQUFZLENBQUMsQ0FBQztJQUNsRCxPQUFPO1FBQ0wsWUFBWSxFQUFFLEdBQUcsQ0FBQyxlQUFlLEdBQUcsWUFBWTtRQUNoRCxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7S0FDdEIsQ0FBQztBQUNKLENBQUM7QUFQRCxnREFPQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGh0dHBzIGZyb20gJ2h0dHBzJztcbmltcG9ydCB7IHBhcnNlIGFzIHVybHBhcnNlIH0gZnJvbSAndXJsJztcbmltcG9ydCAqIGFzIGNvbnN0cyBmcm9tICcuLi8uLi9saWIvcHJvdmlkZXItZnJhbWV3b3JrL3J1bnRpbWUvY29uc3RzJztcblxuZXhwb3J0IGNvbnN0IE1PQ0tfUkVRVUVTVCA9IHtcbiAgUmVzcG9uc2VVUkw6ICdodHRwOi8vcHJlLXNpZ25lZC1TMy11cmwtZm9yLXJlc3BvbnNlL3BhdGgvaW4vYnVja2V0JyxcbiAgTG9naWNhbFJlc291cmNlSWQ6ICdNeVRlc3RSZXNvdXJjZScsXG4gIFJlcXVlc3RJZDogJ3VuaXF1ZWlkLWZvci10aGlzLWNyZWF0ZS1yZXF1ZXN0JyxcbiAgU3RhY2tJZDogJ2Fybjphd3M6Y2xvdWRmb3JtYXRpb246dXMtd2VzdC0yOjEyMzQ1Njc4OTAxMjpzdGFjay9zdGFjay1uYW1lL2d1aWQnLFxufTtcblxuZXhwb3J0IGNvbnN0IE1PQ0tfT05fRVZFTlRfRlVOQ1RJT05fQVJOID0gJ2FybjpsYW1iZGE6dXNlcjpvbjpldmVudCc7XG5leHBvcnQgY29uc3QgTU9DS19JU19DT01QTEVURV9GVU5DVElPTl9BUk4gPSAnYXJuOmxhbWJkYTp1c2VyOmlzOmNvbXBsZXRlJztcbmV4cG9ydCBjb25zdCBNT0NLX1NGTl9BUk4gPSAnYXJuOm9mOnN0YXRlOm1hY2hpbmUnO1xuXG5leHBvcnQgbGV0IHN0cmluZ2lmeVBheWxvYWQgPSB0cnVlO1xuZXhwb3J0IGxldCBvbkV2ZW50SW1wbE1vY2s6IEFXU0NES0FzeW5jQ3VzdG9tUmVzb3VyY2UuT25FdmVudEhhbmRsZXIgfCB1bmRlZmluZWQ7XG5leHBvcnQgbGV0IGlzQ29tcGxldGVJbXBsTW9jazogQVdTQ0RLQXN5bmNDdXN0b21SZXNvdXJjZS5Jc0NvbXBsZXRlSGFuZGxlciB8IHVuZGVmaW5lZDtcbmV4cG9ydCBsZXQgc3RhcnRTdGF0ZU1hY2hpbmVJbnB1dDogQVdTLlN0ZXBGdW5jdGlvbnMuU3RhcnRFeGVjdXRpb25JbnB1dCB8IHVuZGVmaW5lZDtcbmV4cG9ydCBsZXQgY2ZuUmVzcG9uc2U6IEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlUmVzcG9uc2U7XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXR1cCgpIHtcbiAgcHJvY2Vzcy5lbnZbY29uc3RzLldBSVRFUl9TVEFURV9NQUNISU5FX0FSTl9FTlZdID0gTU9DS19TRk5fQVJOO1xuXG4gIHN0cmluZ2lmeVBheWxvYWQgPSB0cnVlO1xuICBvbkV2ZW50SW1wbE1vY2sgPSB1bmRlZmluZWQ7XG4gIGlzQ29tcGxldGVJbXBsTW9jayA9IHVuZGVmaW5lZDtcbiAgY2ZuUmVzcG9uc2UgPSB7fSBhcyBhbnk7XG4gIHN0YXJ0U3RhdGVNYWNoaW5lSW5wdXQgPSB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBodHRwUmVxdWVzdE1vY2sob3B0aW9uczogaHR0cHMuUmVxdWVzdE9wdGlvbnMsIGJvZHk6IHN0cmluZykge1xuICBjb25zdCByZXNwb25zZVVybCA9IHVybHBhcnNlKE1PQ0tfUkVRVUVTVC5SZXNwb25zZVVSTCk7XG5cbiAgZXhwZWN0KG9wdGlvbnMubWV0aG9kKS50b0VxdWFsKCdQVVQnKTtcbiAgZXhwZWN0KG9wdGlvbnMucGF0aCkudG9FcXVhbChyZXNwb25zZVVybC5wYXRoKTtcbiAgZXhwZWN0KG9wdGlvbnMuaG9zdG5hbWUpLnRvRXF1YWwocmVzcG9uc2VVcmwuaG9zdG5hbWUpO1xuICBjb25zdCBoZWFkZXJzID0gb3B0aW9ucy5oZWFkZXJzIHx8IHt9O1xuICBleHBlY3QoaGVhZGVyc1snY29udGVudC1sZW5ndGgnXSkudG9FcXVhbChib2R5Lmxlbmd0aCk7XG4gIGV4cGVjdChoZWFkZXJzWydjb250ZW50LXR5cGUnXSkudG9TdHJpY3RFcXVhbCgnJyk7XG4gIGNmblJlc3BvbnNlID0gSlNPTi5wYXJzZShib2R5KTtcblxuICBpZiAoIWNmblJlc3BvbnNlKSB7IHRocm93IG5ldyBFcnJvcigndW5leHBlY3RlZCcpOyB9XG5cbiAgLy8gd2UgYWx3YXlzIGV4cGVjdCBhIHBoeXNpY2FsIHJlc291cmNlIGlkXG4gIGV4cGVjdChjZm5SZXNwb25zZS5QaHlzaWNhbFJlc291cmNlSWQpLnRvQmVUcnV0aHkoKTtcblxuICAvLyB3ZSBhbHdheXMgZXhwZWN0IGEgcmVhc29uXG4gIGV4cGVjdChjZm5SZXNwb25zZS5SZWFzb24pLnRvQmVUcnV0aHkoKTtcblxuICBleHBlY3QoY2ZuUmVzcG9uc2UuTG9naWNhbFJlc291cmNlSWQpLnRvRXF1YWwoTU9DS19SRVFVRVNULkxvZ2ljYWxSZXNvdXJjZUlkKTtcbiAgZXhwZWN0KGNmblJlc3BvbnNlLlJlcXVlc3RJZCkudG9FcXVhbChNT0NLX1JFUVVFU1QuUmVxdWVzdElkKTtcbiAgZXhwZWN0KGNmblJlc3BvbnNlLlN0YWNrSWQpLnRvRXF1YWwoTU9DS19SRVFVRVNULlN0YWNrSWQpO1xuICBleHBlY3QoY2ZuUmVzcG9uc2UuU3RhdHVzID09PSAnRkFJTEVEJyB8fCBjZm5SZXNwb25zZS5TdGF0dXMgPT09ICdTVUNDRVNTJykudG9CZVRydXRoeSgpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW52b2tlRnVuY3Rpb25Nb2NrKHJlcTogQVdTLkxhbWJkYS5JbnZvY2F0aW9uUmVxdWVzdCk6IFByb21pc2U8QVdTLkxhbWJkYS5JbnZvY2F0aW9uUmVzcG9uc2U+IHtcbiAgaWYgKCFyZXEuUGF5bG9hZCB8fCB0eXBlb2YgKHJlcS5QYXlsb2FkKSAhPT0gJ3N0cmluZycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgcGF5bG9hZCBvZiB0eXBlICR7dHlwZW9mIChyZXEuUGF5bG9hZCl9fWApO1xuICB9XG5cbiAgY29uc3QgaW5wdXQgPSBKU09OLnBhcnNlKHJlcS5QYXlsb2FkKTtcblxuICB0cnkge1xuXG4gICAgbGV0IHJldDtcbiAgICBzd2l0Y2ggKHJlcS5GdW5jdGlvbk5hbWUpIHtcbiAgICAgIGNhc2UgTU9DS19PTl9FVkVOVF9GVU5DVElPTl9BUk46XG4gICAgICAgIGlmICghb25FdmVudEltcGxNb2NrKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUcnlpbmcgdG8gdHJpZ2dlciBcIm9uRXZlbnRcIiBidXQgaXQgaXMgbm90IGltcGxlbWVudGVkJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0ID0gYXdhaXQgb25FdmVudEltcGxNb2NrKGlucHV0IGFzIEFXU0NES0FzeW5jQ3VzdG9tUmVzb3VyY2UuT25FdmVudFJlcXVlc3QpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBNT0NLX0lTX0NPTVBMRVRFX0ZVTkNUSU9OX0FSTjpcbiAgICAgICAgaWYgKCFpc0NvbXBsZXRlSW1wbE1vY2spIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyeWluZyB0byB0cmlnZ2VyIFwiaXNDb21wbGV0ZVwiIGJ1dCBpdCBpcyBub3QgaW1wbGVtZW50ZWQnKTtcbiAgICAgICAgfVxuICAgICAgICByZXQgPSBhd2FpdCBpc0NvbXBsZXRlSW1wbE1vY2soaW5wdXQgYXMgQVdTQ0RLQXN5bmNDdXN0b21SZXNvdXJjZS5Jc0NvbXBsZXRlUmVxdWVzdCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Vua25vd24gbW9jayBmdW5jdGlvbicpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBQYXlsb2FkOiBzdHJpbmdpZnlQYXlsb2FkID8gSlNPTi5zdHJpbmdpZnkocmV0KSA6IHJldCxcbiAgICB9O1xuICB9IGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIEZ1bmN0aW9uRXJyb3I6ICdVbmhhbmRsZWQnLFxuICAgICAgUGF5bG9hZDogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBlcnJvclR5cGU6IGUubmFtZSxcbiAgICAgICAgZXJyb3JNZXNzYWdlOiBlLm1lc3NhZ2UsXG4gICAgICAgIHRyYWNlOiBbXG4gICAgICAgICAgJ0FjY2Vzc0RlbmllZDogQWNjZXNzIERlbmllZCcsXG4gICAgICAgICAgJyAgICBhdCBSZXF1ZXN0LmV4dHJhY3RFcnJvciAoL3Zhci9ydW50aW1lL25vZGVfbW9kdWxlcy9hd3Mtc2RrL2xpYi9zZXJ2aWNlcy9zMy5qczo1ODU6MzUpJyxcbiAgICAgICAgICAnICAgIGF0IFJlcXVlc3QuY2FsbExpc3RlbmVycyAoL3Zhci9ydW50aW1lL25vZGVfbW9kdWxlcy9hd3Mtc2RrL2xpYi9zZXF1ZW50aWFsX2V4ZWN1dG9yLmpzOjEwNjoyMCknLFxuICAgICAgICAgICcgICAgYXQgUmVxdWVzdC5lbWl0ICgvdmFyL3J1bnRpbWUvbm9kZV9tb2R1bGVzL2F3cy1zZGsvbGliL3NlcXVlbnRpYWxfZXhlY3V0b3IuanM6Nzg6MTApJyxcbiAgICAgICAgICAnICAgIGF0IFJlcXVlc3QuZW1pdCAoL3Zhci9ydW50aW1lL25vZGVfbW9kdWxlcy9hd3Mtc2RrL2xpYi9yZXF1ZXN0LmpzOjY4MzoxNCknLFxuICAgICAgICAgICcgICAgYXQgUmVxdWVzdC50cmFuc2l0aW9uICgvdmFyL3J1bnRpbWUvbm9kZV9tb2R1bGVzL2F3cy1zZGsvbGliL3JlcXVlc3QuanM6MjI6MTApJyxcbiAgICAgICAgICAnICAgIGF0IEFjY2VwdG9yU3RhdGVNYWNoaW5lLnJ1blRvICgvdmFyL3J1bnRpbWUvbm9kZV9tb2R1bGVzL2F3cy1zZGsvbGliL3N0YXRlX21hY2hpbmUuanM6MTQ6MTIpJyxcbiAgICAgICAgICAnICAgIGF0IC92YXIvcnVudGltZS9ub2RlX21vZHVsZXMvYXdzLXNkay9saWIvc3RhdGVfbWFjaGluZS5qczoyNjoxMCcsXG4gICAgICAgICAgJyAgICBhdCBSZXF1ZXN0Ljxhbm9ueW1vdXM+ICgvdmFyL3J1bnRpbWUvbm9kZV9tb2R1bGVzL2F3cy1zZGsvbGliL3JlcXVlc3QuanM6Mzg6OSknLFxuICAgICAgICAgICcgICAgYXQgUmVxdWVzdC48YW5vbnltb3VzPiAoL3Zhci9ydW50aW1lL25vZGVfbW9kdWxlcy9hd3Mtc2RrL2xpYi9yZXF1ZXN0LmpzOjY4NToxMiknLFxuICAgICAgICAgICcgICAgYXQgUmVxdWVzdC5jYWxsTGlzdGVuZXJzICgvdmFyL3J1bnRpbWUvbm9kZV9tb2R1bGVzL2F3cy1zZGsvbGliL3NlcXVlbnRpYWxfZXhlY3V0b3IuanM6MTE2OjE4KScsXG4gICAgICAgIF0sXG4gICAgICB9KSxcbiAgICB9O1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmVwYXJlRm9yRXhlY3V0aW9uKCkge1xuICBzdGFydFN0YXRlTWFjaGluZUlucHV0ID0gdW5kZWZpbmVkO1xuXG4gIGlmIChvbkV2ZW50SW1wbE1vY2spIHtcbiAgICBwcm9jZXNzLmVudltjb25zdHMuVVNFUl9PTl9FVkVOVF9GVU5DVElPTl9BUk5fRU5WXSA9IE1PQ0tfT05fRVZFTlRfRlVOQ1RJT05fQVJOO1xuICB9IGVsc2Uge1xuICAgIGRlbGV0ZSBwcm9jZXNzLmVudltjb25zdHMuVVNFUl9PTl9FVkVOVF9GVU5DVElPTl9BUk5fRU5WXTtcbiAgfVxuXG4gIGlmIChpc0NvbXBsZXRlSW1wbE1vY2spIHtcbiAgICBwcm9jZXNzLmVudltjb25zdHMuVVNFUl9JU19DT01QTEVURV9GVU5DVElPTl9BUk5fRU5WXSA9IE1PQ0tfSVNfQ09NUExFVEVfRlVOQ1RJT05fQVJOO1xuICB9IGVsc2Uge1xuICAgIGRlbGV0ZSBwcm9jZXNzLmVudltjb25zdHMuVVNFUl9JU19DT01QTEVURV9GVU5DVElPTl9BUk5fRU5WXTtcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc3RhcnRFeGVjdXRpb25Nb2NrKHJlcTogQVdTLlN0ZXBGdW5jdGlvbnMuU3RhcnRFeGVjdXRpb25JbnB1dCkge1xuICBzdGFydFN0YXRlTWFjaGluZUlucHV0ID0gcmVxO1xuICBleHBlY3QocmVxLnN0YXRlTWFjaGluZUFybikudG9FcXVhbChNT0NLX1NGTl9BUk4pO1xuICByZXR1cm4ge1xuICAgIGV4ZWN1dGlvbkFybjogcmVxLnN0YXRlTWFjaGluZUFybiArICcvZXhlY3V0aW9uJyxcbiAgICBzdGFydERhdGU6IG5ldyBEYXRlKCksXG4gIH07XG59XG4iXX0=