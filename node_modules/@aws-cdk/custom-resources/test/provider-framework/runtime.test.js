"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable: no-console
// tslint:disable: max-line-length
/* eslint-disable @typescript-eslint/no-require-imports */
const cfnResponse = require("../../lib/provider-framework/runtime/cfn-response");
const framework = require("../../lib/provider-framework/runtime/framework");
const outbound = require("../../lib/provider-framework/runtime/outbound");
const mocks = require("./mocks");
/* eslint-enable */
console.log = jest.fn();
cfnResponse.includeStackTraces = false;
const MOCK_PHYSICAL_ID = 'mock-physical-resource-id';
const MOCK_PROPS = { Name: 'Value', List: ['1', '2', '3'], ServiceToken: 'bla' };
const MOCK_ATTRS = { MyAttribute: 'my-mock-attribute' };
outbound.httpRequest = mocks.httpRequestMock;
outbound.invokeFunction = mocks.invokeFunctionMock;
outbound.startExecution = mocks.startExecutionMock;
beforeEach(() => mocks.setup());
test('async flow: isComplete returns true only after 3 times', async () => {
    let isCompleteCalls = 0;
    mocks.onEventImplMock = async (event) => {
        expect(event.RequestType).toEqual('Create');
        expect(event.ResourceProperties).toStrictEqual(MOCK_PROPS);
        expect(event.PhysicalResourceId).toBeUndefined(); // physical ID in CREATE
        return {
            PhysicalResourceId: MOCK_PHYSICAL_ID,
            Data: MOCK_ATTRS,
            ArbitraryField: 1234,
        };
    };
    mocks.isCompleteImplMock = async (event) => {
        isCompleteCalls++;
        expect(event.ArbitraryField).toEqual(1234); // any field is passed through
        expect(event.PhysicalResourceId).toEqual(MOCK_PHYSICAL_ID); // physical ID returned from onEvent is passed to "isComplete"
        expect(event.Data).toStrictEqual(MOCK_ATTRS); // attributes are propagated between the calls
        const result = isCompleteCalls === 3;
        if (!result) {
            return {
                IsComplete: false,
            };
        }
        return {
            IsComplete: true,
            Data: {
                Additional: 'attribute',
            },
        };
    };
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
        ResourceProperties: MOCK_PROPS,
    });
    // THEN
    expect(isCompleteCalls).toEqual(3);
    expectCloudFormationSuccess({
        PhysicalResourceId: MOCK_PHYSICAL_ID,
        Data: {
            ...MOCK_ATTRS,
            Additional: 'attribute',
        },
    });
});
test('isComplete throws in the first invocation', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ PhysicalResourceId: MOCK_PHYSICAL_ID });
    mocks.isCompleteImplMock = async () => { throw new Error('Some failure'); };
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
        ResourceProperties: MOCK_PROPS,
    });
    expectCloudFormationFailed('Some failure');
});
test('fails gracefully if "onEvent" throws an error', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => { throw new Error('error thrown during onEvent'); };
    mocks.isCompleteImplMock = async () => ({ IsComplete: true });
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
    });
    // THEN
    expectCloudFormationFailed('error thrown during onEvent');
    expectNoWaiter();
});
describe('PhysicalResourceId', () => {
    describe('if not omitted from onEvent result', () => {
        it('defaults to RequestId for CREATE', async () => {
            // WHEN
            mocks.onEventImplMock = async () => undefined;
            // THEN
            await simulateEvent({
                RequestType: 'Create',
            });
            expectCloudFormationSuccess({
                PhysicalResourceId: mocks.MOCK_REQUEST.RequestId,
            });
        });
        it('defaults to the current PhysicalResourceId for UPDATE', async () => {
            // WHEN
            mocks.onEventImplMock = async () => undefined;
            // THEN
            await simulateEvent({
                RequestType: 'Update',
                PhysicalResourceId: MOCK_PHYSICAL_ID,
            });
            expectCloudFormationSuccess({
                PhysicalResourceId: MOCK_PHYSICAL_ID,
            });
        });
        it('defaults to the current PhysicalResourceId for DELETE', async () => {
            // WHEN
            mocks.onEventImplMock = async () => undefined;
            // THEN
            await simulateEvent({
                RequestType: 'Delete',
                PhysicalResourceId: MOCK_PHYSICAL_ID,
            });
            expectCloudFormationSuccess({
                PhysicalResourceId: MOCK_PHYSICAL_ID,
            });
        });
    });
    test('UPDATE: can change the physical ID by returning a new ID', async () => {
        // GIVEN
        mocks.onEventImplMock = async () => ({ PhysicalResourceId: 'NewPhysicalId' });
        mocks.isCompleteImplMock = async () => ({ IsComplete: true });
        // WHEN
        await simulateEvent({
            RequestType: 'Update',
            PhysicalResourceId: 'CurrentPhysicalId',
        });
        // THEN
        expectCloudFormationSuccess({
            PhysicalResourceId: 'NewPhysicalId',
        });
    });
    test('DELETE: cannot change the physical resource ID during a delete', async () => {
        // GIVEN
        mocks.onEventImplMock = async () => ({ PhysicalResourceId: 'NewPhysicalId' });
        mocks.isCompleteImplMock = async () => ({ IsComplete: true });
        // WHEN
        await simulateEvent({
            RequestType: 'Delete',
            PhysicalResourceId: 'CurrentPhysicalId',
        });
        // THEN
        expectNoWaiter();
        expectCloudFormationFailed('DELETE: cannot change the physical resource ID from "CurrentPhysicalId" to "NewPhysicalId" during deletion');
    });
});
test('isComplete always returns "false" and then a timeout occurs', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ Data: { Foo: 123 }, PhysicalResourceId: MOCK_PHYSICAL_ID });
    mocks.isCompleteImplMock = async () => ({ IsComplete: false });
    // WHEN
    await simulateEvent({
        RequestType: 'Update',
        PhysicalResourceId: MOCK_PHYSICAL_ID,
    });
    // THEN
    expectCloudFormationFailed('Operation timed out');
});
test('isComplete: "Data" is not allowed if InComplete is "False"', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ Data: { Foo: 123 }, PhysicalResourceId: MOCK_PHYSICAL_ID });
    mocks.isCompleteImplMock = async () => ({ IsComplete: false, Data: { Foo: 3333 } });
    // WHEN
    await simulateEvent({
        RequestType: 'Update',
        PhysicalResourceId: MOCK_PHYSICAL_ID,
    });
    expectCloudFormationFailed('"Data" is not allowed if "IsComplete" is "False"');
});
test('if there is no user-defined "isComplete", the waiter will not be triggered or needed', async () => {
    // GIVEN
    mocks.onEventImplMock = async () => ({ PhysicalResourceId: MOCK_PHYSICAL_ID });
    // WHEN
    await simulateEvent({
        RequestType: 'Create',
    });
    // THEN
    expectNoWaiter();
    expectCloudFormationSuccess({ PhysicalResourceId: MOCK_PHYSICAL_ID });
});
test('fails if user handler returns a non-object response', async () => {
    // GIVEN
    mocks.stringifyPayload = false;
    mocks.onEventImplMock = async () => 'string';
    // WHEN
    await simulateEvent({ RequestType: 'Create' });
    // THEN
    expectCloudFormationFailed('return values from user-handlers must be JSON objects. got: \"string\"');
});
describe('if CREATE fails, the subsequent DELETE will be ignored', () => {
    it('FAILED response sets PhysicalResourceId to a special marker', async () => {
        // WHEN
        mocks.onEventImplMock = async () => { throw new Error('CREATE FAILED'); };
        // THEN
        await simulateEvent({
            RequestType: 'Create',
        });
        expectCloudFormationFailed('CREATE FAILED', {
            PhysicalResourceId: cfnResponse.CREATE_FAILED_PHYSICAL_ID_MARKER,
        });
    });
    it('DELETE request with the marker succeeds without calling user handler', async () => {
        // GIVEN
        // user handler is not assigned
        // WHEN
        await simulateEvent({
            RequestType: 'Delete',
            PhysicalResourceId: cfnResponse.CREATE_FAILED_PHYSICAL_ID_MARKER,
        });
        // THEN
        expectCloudFormationSuccess();
    });
});
// -----------------------------------------------------------------------------------------------------------------------
/**
 * Triggers the custom resource lifecycle event flow by invoking the framework's
 * onEvent function and then, if the waiter state machine was started, simulates
 * the waiter and invokes isComplete and onTimeout as appropriate.
 */
async function simulateEvent(req) {
    const x = {
        ServiceToken: 'SERVICE-TOKEN',
        ResponseURL: mocks.MOCK_REQUEST.ResponseURL,
        StackId: mocks.MOCK_REQUEST.StackId,
        RequestId: mocks.MOCK_REQUEST.RequestId,
        ResourceType: 'Custom::TestResource',
        LogicalResourceId: mocks.MOCK_REQUEST.LogicalResourceId,
        ...req,
    };
    mocks.prepareForExecution();
    await framework.onEvent(x);
    // if the FSM
    if (mocks.startStateMachineInput && mocks.startStateMachineInput.stateMachineArn === mocks.MOCK_SFN_ARN) {
        await simulateWaiter(JSON.parse(mocks.startStateMachineInput.input));
    }
    async function simulateWaiter(event) {
        let retry = true;
        let count = 5;
        while (retry) {
            try {
                await framework.isComplete(event);
                retry = false;
            }
            catch (e) {
                if (e instanceof cfnResponse.Retry) {
                    if (count-- === 0) {
                        await framework.onTimeout({ Cause: JSON.stringify({ errorMessage: e.message }) });
                        retry = false;
                    }
                    else {
                        retry = true;
                        continue;
                    }
                }
                else {
                    throw new Error(e);
                }
            }
        }
    }
}
function expectCloudFormationFailed(expectedReason, resp) {
    expectCloudFormationResponse({
        Status: 'FAILED',
        Reason: expectedReason,
        ...resp,
    });
}
function expectCloudFormationSuccess(resp) {
    if (mocks.cfnResponse.Status !== 'SUCCESS') {
        console.error(mocks.cfnResponse.Reason || '<NO REASON>');
    }
    expectCloudFormationResponse({ Status: 'SUCCESS', ...resp });
}
function expectCloudFormationResponse(resp = {}) {
    for (const [key, expected] of Object.entries(resp)) {
        const actual = mocks.cfnResponse[key];
        expect(actual).toStrictEqual(expected);
    }
}
function expectNoWaiter() {
    expect(mocks.startStateMachineInput).toBeUndefined();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVudGltZS50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicnVudGltZS50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQTZCO0FBQzdCLGtDQUFrQztBQUNsQywwREFBMEQ7QUFDMUQsaUZBQWtGO0FBQ2xGLDRFQUE2RTtBQUM3RSwwRUFBMkU7QUFDM0UsaUNBQWtDO0FBQ2xDLG1CQUFtQjtBQUVuQixPQUFPLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUV4QixXQUFXLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDO0FBRXZDLE1BQU0sZ0JBQWdCLEdBQUcsMkJBQTJCLENBQUM7QUFDckQsTUFBTSxVQUFVLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxDQUFDO0FBQ2pGLE1BQU0sVUFBVSxHQUFHLEVBQUUsV0FBVyxFQUFFLG1CQUFtQixFQUFFLENBQUM7QUFFeEQsUUFBUSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsZUFBZSxDQUFDO0FBQzdDLFFBQVEsQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDLGtCQUFrQixDQUFDO0FBQ25ELFFBQVEsQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDLGtCQUFrQixDQUFDO0FBRW5ELFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztBQUVoQyxJQUFJLENBQUMsd0RBQXdELEVBQUUsS0FBSyxJQUFJLEVBQUU7SUFDeEUsSUFBSSxlQUFlLEdBQUcsQ0FBQyxDQUFDO0lBRXhCLEtBQUssQ0FBQyxlQUFlLEdBQUcsS0FBSyxFQUFDLEtBQUssRUFBQyxFQUFFO1FBQ3BDLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxD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LENBQUMsQ0FBQztBQUMvRCxDQUFDO0FBRUQsU0FBUyw0QkFBNEIsQ0FBQyxPQUFnRSxFQUFFO0lBQ3RHLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ2xELE1BQU0sTUFBTSxHQUFJLEtBQUssQ0FBQyxXQUFtQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9DLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBZSxDQUFDLENBQUM7S0FDL0M7QUFDSCxDQUFDO0FBRUQsU0FBUyxjQUFjO0lBQ3JCLE1BQU0sQ0FBQyxLQUFLLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUN2RCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHNsaW50OmRpc2FibGU6IG5vLWNvbnNvbGVcbi8vIHRzbGludDpkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGhcbi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby1yZXF1aXJlLWltcG9ydHMgKi9cbmltcG9ydCBjZm5SZXNwb25zZSA9IHJlcXVpcmUoJy4uLy4uL2xpYi9wcm92aWRlci1mcmFtZXdvcmsvcnVudGltZS9jZm4tcmVzcG9uc2UnKTtcbmltcG9ydCBmcmFtZXdvcmsgPSByZXF1aXJlKCcuLi8uLi9saWIvcHJvdmlkZXItZnJhbWV3b3JrL3J1bnRpbWUvZnJhbWV3b3JrJyk7XG5pbXBvcnQgb3V0Ym91bmQgPSByZXF1aXJlKCcuLi8uLi9saWIvcHJvdmlkZXItZnJhbWV3b3JrL3J1bnRpbWUvb3V0Ym91bmQnKTtcbmltcG9ydCBtb2NrcyA9IHJlcXVpcmUoJy4vbW9ja3MnKTtcbi8qIGVzbGludC1lbmFibGUgKi9cblxuY29uc29sZS5sb2cgPSBqZXN0LmZuKCk7XG5cbmNmblJlc3BvbnNlLmluY2x1ZGVTdGFja1RyYWNlcyA9IGZhbHNlO1xuXG5jb25zdCBNT0NLX1BIWVNJQ0FMX0lEID0gJ21vY2stcGh5c2ljYWwtcmVzb3VyY2UtaWQnO1xuY29uc3QgTU9DS19QUk9QUyA9IHsgTmFtZTogJ1ZhbHVlJywgTGlzdDogWycxJywgJzInLCAnMyddLCBTZXJ2aWNlVG9rZW46ICdibGEnIH07XG5jb25zdCBNT0NLX0FUVFJTID0geyBNeUF0dHJpYnV0ZTogJ215LW1vY2stYXR0cmlidXRlJyB9O1xuXG5vdXRib3VuZC5odHRwUmVxdWVzdCA9IG1vY2tzLmh0dHBSZXF1ZXN0TW9jaztcbm91dGJvdW5kLmludm9rZUZ1bmN0aW9uID0gbW9ja3MuaW52b2tlRnVuY3Rpb25Nb2NrO1xub3V0Ym91bmQuc3RhcnRFeGVjdXRpb24gPSBtb2Nrcy5zdGFydEV4ZWN1dGlvbk1vY2s7XG5cbmJlZm9yZUVhY2goKCkgPT4gbW9ja3Muc2V0dXAoKSk7XG5cbnRlc3QoJ2FzeW5jIGZsb3c6IGlzQ29tcGxldGUgcmV0dXJucyB0cnVlIG9ubHkgYWZ0ZXIgMyB0aW1lcycsIGFzeW5jICgpID0+IHtcbiAgbGV0IGlzQ29tcGxldGVDYWxscyA9IDA7XG5cbiAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgZXZlbnQgPT4ge1xuICAgIGV4cGVjdChldmVudC5SZXF1ZXN0VHlwZSkudG9FcXVhbCgnQ3JlYXRlJyk7XG4gICAgZXhwZWN0KGV2ZW50LlJlc291cmNlUHJvcGVydGllcykudG9TdHJpY3RFcXVhbChNT0NLX1BST1BTKTtcbiAgICBleHBlY3QoZXZlbnQuUGh5c2ljYWxSZXNvdXJjZUlkKS50b0JlVW5kZWZpbmVkKCk7IC8vIHBoeXNpY2FsIElEIGluIENSRUFURVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCxcbiAgICAgIERhdGE6IE1PQ0tfQVRUUlMsXG4gICAgICBBcmJpdHJhcnlGaWVsZDogMTIzNCxcbiAgICB9O1xuICB9O1xuXG4gIG1vY2tzLmlzQ29tcGxldGVJbXBsTW9jayA9IGFzeW5jIGV2ZW50ID0+IHtcbiAgICBpc0NvbXBsZXRlQ2FsbHMrKztcbiAgICBleHBlY3QoKGV2ZW50IGFzIGFueSkuQXJiaXRyYXJ5RmllbGQpLnRvRXF1YWwoMTIzNCk7IC8vIGFueSBmaWVsZCBpcyBwYXNzZWQgdGhyb3VnaFxuICAgIGV4cGVjdChldmVudC5QaHlzaWNhbFJlc291cmNlSWQpLnRvRXF1YWwoTU9DS19QSFlTSUNBTF9JRCk7IC8vIHBoeXNpY2FsIElEIHJldHVybmVkIGZyb20gb25FdmVudCBpcyBwYXNzZWQgdG8gXCJpc0NvbXBsZXRlXCJcbiAgICBleHBlY3QoZXZlbnQuRGF0YSkudG9TdHJpY3RFcXVhbChNT0NLX0FUVFJTKTsgLy8gYXR0cmlidXRlcyBhcmUgcHJvcGFnYXRlZCBiZXR3ZWVuIHRoZSBjYWxsc1xuXG4gICAgY29uc3QgcmVzdWx0ID0gaXNDb21wbGV0ZUNhbGxzID09PSAzO1xuICAgIGlmICghcmVzdWx0KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBJc0NvbXBsZXRlOiBmYWxzZSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIElzQ29tcGxldGU6IHRydWUsXG4gICAgICBEYXRhOiB7XG4gICAgICAgIEFkZGl0aW9uYWw6ICdhdHRyaWJ1dGUnLCAvLyBhZGRpdGlvbmFsIGF0dHJpYnV0ZXMgY2FuIGJlIHJldHVybmVkIGZyb20gXCJpc0NvbXBsZXRlXCJcbiAgICAgIH0sXG4gICAgfTtcbiAgfTtcblxuICAvLyBXSEVOXG4gIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgIFJlcXVlc3RUeXBlOiAnQ3JlYXRlJyxcbiAgICBSZXNvdXJjZVByb3BlcnRpZXM6IE1PQ0tfUFJPUFMsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KGlzQ29tcGxldGVDYWxscykudG9FcXVhbCgzKTtcblxuICBleHBlY3RDbG91ZEZvcm1hdGlvblN1Y2Nlc3Moe1xuICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCxcbiAgICBEYXRhOiB7XG4gICAgICAuLi5NT0NLX0FUVFJTLFxuICAgICAgQWRkaXRpb25hbDogJ2F0dHJpYnV0ZScsXG4gICAgfSxcbiAgfSk7XG59KTtcblxudGVzdCgnaXNDb21wbGV0ZSB0aHJvd3MgaW4gdGhlIGZpcnN0IGludm9jYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCB9KTtcbiAgbW9ja3MuaXNDb21wbGV0ZUltcGxNb2NrID0gYXN5bmMgKCkgPT4geyB0aHJvdyBuZXcgRXJyb3IoJ1NvbWUgZmFpbHVyZScpOyB9O1xuXG4gIC8vIFdIRU5cbiAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgUmVxdWVzdFR5cGU6ICdDcmVhdGUnLFxuICAgIFJlc291cmNlUHJvcGVydGllczogTU9DS19QUk9QUyxcbiAgfSk7XG5cbiAgZXhwZWN0Q2xvdWRGb3JtYXRpb25GYWlsZWQoJ1NvbWUgZmFpbHVyZScpO1xufSk7XG5cbnRlc3QoJ2ZhaWxzIGdyYWNlZnVsbHkgaWYgXCJvbkV2ZW50XCIgdGhyb3dzIGFuIGVycm9yJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiB7IHRocm93IG5ldyBFcnJvcignZXJyb3IgdGhyb3duIGR1cmluZyBvbkV2ZW50Jyk7IH07XG4gIG1vY2tzLmlzQ29tcGxldGVJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IElzQ29tcGxldGU6IHRydWUgfSk7XG5cbiAgLy8gV0hFTlxuICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gIH0pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0Q2xvdWRGb3JtYXRpb25GYWlsZWQoJ2Vycm9yIHRocm93biBkdXJpbmcgb25FdmVudCcpO1xuICBleHBlY3ROb1dhaXRlcigpO1xufSk7XG5cbmRlc2NyaWJlKCdQaHlzaWNhbFJlc291cmNlSWQnLCAoKSA9PiB7XG5cbiAgZGVzY3JpYmUoJ2lmIG5vdCBvbWl0dGVkIGZyb20gb25FdmVudCByZXN1bHQnLCAoKSA9PiB7XG5cbiAgICBpdCgnZGVmYXVsdHMgdG8gUmVxdWVzdElkIGZvciBDUkVBVEUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBXSEVOXG4gICAgICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiB1bmRlZmluZWQ7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgICAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0Q2xvdWRGb3JtYXRpb25TdWNjZXNzKHtcbiAgICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBtb2Nrcy5NT0NLX1JFUVVFU1QuUmVxdWVzdElkLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnZGVmYXVsdHMgdG8gdGhlIGN1cnJlbnQgUGh5c2ljYWxSZXNvdXJjZUlkIGZvciBVUERBVEUnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBXSEVOXG4gICAgICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiB1bmRlZmluZWQ7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgICAgICBSZXF1ZXN0VHlwZTogJ1VwZGF0ZScsXG4gICAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCxcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3RDbG91ZEZvcm1hdGlvblN1Y2Nlc3Moe1xuICAgICAgICBQaHlzaWNhbFJlc291cmNlSWQ6IE1PQ0tfUEhZU0lDQUxfSUQsXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdkZWZhdWx0cyB0byB0aGUgY3VycmVudCBQaHlzaWNhbFJlc291cmNlSWQgZm9yIERFTEVURScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFdIRU5cbiAgICAgIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+IHVuZGVmaW5lZDtcblxuICAgICAgLy8gVEhFTlxuICAgICAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgICAgIFJlcXVlc3RUeXBlOiAnRGVsZXRlJyxcbiAgICAgICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lELFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdENsb3VkRm9ybWF0aW9uU3VjY2Vzcyh7XG4gICAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdVUERBVEU6IGNhbiBjaGFuZ2UgdGhlIHBoeXNpY2FsIElEIGJ5IHJldHVybmluZyBhIG5ldyBJRCcsIGFzeW5jICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IFBoeXNpY2FsUmVzb3VyY2VJZDogJ05ld1BoeXNpY2FsSWQnIH0pO1xuICAgIG1vY2tzLmlzQ29tcGxldGVJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IElzQ29tcGxldGU6IHRydWUgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgICBSZXF1ZXN0VHlwZTogJ1VwZGF0ZScsXG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQ6ICdDdXJyZW50UGh5c2ljYWxJZCcsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0Q2xvdWRGb3JtYXRpb25TdWNjZXNzKHtcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogJ05ld1BoeXNpY2FsSWQnLFxuICAgIH0pO1xuICB9KTtcblxuICB0ZXN0KCdERUxFVEU6IGNhbm5vdCBjaGFuZ2UgdGhlIHBoeXNpY2FsIHJlc291cmNlIElEIGR1cmluZyBhIGRlbGV0ZScsIGFzeW5jICgpID0+IHtcbiAgICAvLyBHSVZFTlxuICAgIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IFBoeXNpY2FsUmVzb3VyY2VJZDogJ05ld1BoeXNpY2FsSWQnIH0pO1xuICAgIG1vY2tzLmlzQ29tcGxldGVJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IElzQ29tcGxldGU6IHRydWUgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgICBSZXF1ZXN0VHlwZTogJ0RlbGV0ZScsXG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQ6ICdDdXJyZW50UGh5c2ljYWxJZCcsXG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0Tm9XYWl0ZXIoKTtcbiAgICBleHBlY3RDbG91ZEZvcm1hdGlvbkZhaWxlZCgnREVMRVRFOiBjYW5ub3QgY2hhbmdlIHRoZSBwaHlzaWNhbCByZXNvdXJjZSBJRCBmcm9tIFwiQ3VycmVudFBoeXNpY2FsSWRcIiB0byBcIk5ld1BoeXNpY2FsSWRcIiBkdXJpbmcgZGVsZXRpb24nKTtcbiAgfSk7XG5cbn0pO1xuXG50ZXN0KCdpc0NvbXBsZXRlIGFsd2F5cyByZXR1cm5zIFwiZmFsc2VcIiBhbmQgdGhlbiBhIHRpbWVvdXQgb2NjdXJzJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiAoeyBEYXRhOiB7IEZvbzogMTIzIH0sIFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCB9KTtcbiAgbW9ja3MuaXNDb21wbGV0ZUltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgSXNDb21wbGV0ZTogZmFsc2UgfSk7XG5cbiAgLy8gV0hFTlxuICBhd2FpdCBzaW11bGF0ZUV2ZW50KHtcbiAgICBSZXF1ZXN0VHlwZTogJ1VwZGF0ZScsXG4gICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lELFxuICB9KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uRmFpbGVkKCdPcGVyYXRpb24gdGltZWQgb3V0Jyk7XG59KTtcblxudGVzdCgnaXNDb21wbGV0ZTogXCJEYXRhXCIgaXMgbm90IGFsbG93ZWQgaWYgSW5Db21wbGV0ZSBpcyBcIkZhbHNlXCInLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIG1vY2tzLm9uRXZlbnRJbXBsTW9jayA9IGFzeW5jICgpID0+ICh7IERhdGE6IHsgRm9vOiAxMjMgfSwgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lEIH0pO1xuICBtb2Nrcy5pc0NvbXBsZXRlSW1wbE1vY2sgPSBhc3luYyAoKSA9PiAoeyBJc0NvbXBsZXRlOiBmYWxzZSwgRGF0YTogeyBGb286IDMzMzMgfSB9KTtcblxuICAvLyBXSEVOXG4gIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgIFJlcXVlc3RUeXBlOiAnVXBkYXRlJyxcbiAgICBQaHlzaWNhbFJlc291cmNlSWQ6IE1PQ0tfUEhZU0lDQUxfSUQsXG4gIH0pO1xuXG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uRmFpbGVkKCdcIkRhdGFcIiBpcyBub3QgYWxsb3dlZCBpZiBcIklzQ29tcGxldGVcIiBpcyBcIkZhbHNlXCInKTtcbn0pO1xuXG50ZXN0KCdpZiB0aGVyZSBpcyBubyB1c2VyLWRlZmluZWQgXCJpc0NvbXBsZXRlXCIsIHRoZSB3YWl0ZXIgd2lsbCBub3QgYmUgdHJpZ2dlcmVkIG9yIG5lZWRlZCcsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgKCkgPT4gKHsgUGh5c2ljYWxSZXNvdXJjZUlkOiBNT0NLX1BIWVNJQ0FMX0lEIH0pO1xuXG4gIC8vIFdIRU5cbiAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgUmVxdWVzdFR5cGU6ICdDcmVhdGUnLFxuICB9KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdE5vV2FpdGVyKCk7XG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uU3VjY2Vzcyh7IFBoeXNpY2FsUmVzb3VyY2VJZDogTU9DS19QSFlTSUNBTF9JRCB9KTtcbn0pO1xuXG50ZXN0KCdmYWlscyBpZiB1c2VyIGhhbmRsZXIgcmV0dXJucyBhIG5vbi1vYmplY3QgcmVzcG9uc2UnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIG1vY2tzLnN0cmluZ2lmeVBheWxvYWQgPSBmYWxzZTtcbiAgbW9ja3Mub25FdmVudEltcGxNb2NrID0gYXN5bmMgKCkgPT4gJ3N0cmluZycgYXMgYW55O1xuXG4gIC8vIFdIRU5cbiAgYXdhaXQgc2ltdWxhdGVFdmVudCh7IFJlcXVlc3RUeXBlOiAnQ3JlYXRlJyB9KTtcblxuICAvLyBUSEVOXG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uRmFpbGVkKCdyZXR1cm4gdmFsdWVzIGZyb20gdXNlci1oYW5kbGVycyBtdXN0IGJlIEpTT04gb2JqZWN0cy4gZ290OiBcXFwic3RyaW5nXFxcIicpO1xufSk7XG5cbmRlc2NyaWJlKCdpZiBDUkVBVEUgZmFpbHMsIHRoZSBzdWJzZXF1ZW50IERFTEVURSB3aWxsIGJlIGlnbm9yZWQnLCAoKSA9PiB7XG5cbiAgaXQoJ0ZBSUxFRCByZXNwb25zZSBzZXRzIFBoeXNpY2FsUmVzb3VyY2VJZCB0byBhIHNwZWNpYWwgbWFya2VyJywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBtb2Nrcy5vbkV2ZW50SW1wbE1vY2sgPSBhc3luYyAoKSA9PiB7IHRocm93IG5ldyBFcnJvcignQ1JFQVRFIEZBSUxFRCcpOyB9O1xuXG4gICAgLy8gVEhFTlxuICAgIGF3YWl0IHNpbXVsYXRlRXZlbnQoe1xuICAgICAgUmVxdWVzdFR5cGU6ICdDcmVhdGUnLFxuICAgIH0pO1xuXG4gICAgZXhwZWN0Q2xvdWRGb3JtYXRpb25GYWlsZWQoJ0NSRUFURSBGQUlMRUQnLCB7XG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQ6IGNmblJlc3BvbnNlLkNSRUFURV9GQUlMRURfUEhZU0lDQUxfSURfTUFSS0VSLFxuICAgIH0pO1xuICB9KTtcblxuICBpdCgnREVMRVRFIHJlcXVlc3Qgd2l0aCB0aGUgbWFya2VyIHN1Y2NlZWRzIHdpdGhvdXQgY2FsbGluZyB1c2VyIGhhbmRsZXInLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICAvLyB1c2VyIGhhbmRsZXIgaXMgbm90IGFzc2lnbmVkXG5cbiAgICAvLyBXSEVOXG4gICAgYXdhaXQgc2ltdWxhdGVFdmVudCh7XG4gICAgICBSZXF1ZXN0VHlwZTogJ0RlbGV0ZScsXG4gICAgICBQaHlzaWNhbFJlc291cmNlSWQ6IGNmblJlc3BvbnNlLkNSRUFURV9GQUlMRURfUEhZU0lDQUxfSURfTUFSS0VSLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdENsb3VkRm9ybWF0aW9uU3VjY2VzcygpO1xuICB9KTtcblxufSk7XG5cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbi8qKlxuICogVHJpZ2dlcnMgdGhlIGN1c3RvbSByZXNvdXJjZSBsaWZlY3ljbGUgZXZlbnQgZmxvdyBieSBpbnZva2luZyB0aGUgZnJhbWV3b3JrJ3NcbiAqIG9uRXZlbnQgZnVuY3Rpb24gYW5kIHRoZW4sIGlmIHRoZSB3YWl0ZXIgc3RhdGUgbWFjaGluZSB3YXMgc3RhcnRlZCwgc2ltdWxhdGVzXG4gKiB0aGUgd2FpdGVyIGFuZCBpbnZva2VzIGlzQ29tcGxldGUgYW5kIG9uVGltZW91dCBhcyBhcHByb3ByaWF0ZS5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gc2ltdWxhdGVFdmVudChyZXE6IFBhcnRpYWw8QVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudD4pIHtcbiAgY29uc3QgeCA9IHtcbiAgICBTZXJ2aWNlVG9rZW46ICdTRVJWSUNFLVRPS0VOJyxcbiAgICBSZXNwb25zZVVSTDogbW9ja3MuTU9DS19SRVFVRVNULlJlc3BvbnNlVVJMLFxuICAgIFN0YWNrSWQ6IG1vY2tzLk1PQ0tfUkVRVUVTVC5TdGFja0lkLFxuICAgIFJlcXVlc3RJZDogbW9ja3MuTU9DS19SRVFVRVNULlJlcXVlc3RJZCxcbiAgICBSZXNvdXJjZVR5cGU6ICdDdXN0b206OlRlc3RSZXNvdXJjZScsXG4gICAgTG9naWNhbFJlc291cmNlSWQ6IG1vY2tzLk1PQ0tfUkVRVUVTVC5Mb2dpY2FsUmVzb3VyY2VJZCxcbiAgICAuLi5yZXEsXG4gIH07XG5cbiAgbW9ja3MucHJlcGFyZUZvckV4ZWN1dGlvbigpO1xuXG4gIGF3YWl0IGZyYW1ld29yay5vbkV2ZW50KHggYXMgQVdTTGFtYmRhLkNsb3VkRm9ybWF0aW9uQ3VzdG9tUmVzb3VyY2VFdmVudCk7XG5cbiAgLy8gaWYgdGhlIEZTTVxuICBpZiAobW9ja3Muc3RhcnRTdGF0ZU1hY2hpbmVJbnB1dCAmJiBtb2Nrcy5zdGFydFN0YXRlTWFjaGluZUlucHV0LnN0YXRlTWFjaGluZUFybiA9PT0gbW9ja3MuTU9DS19TRk5fQVJOKSB7XG4gICAgYXdhaXQgc2ltdWxhdGVXYWl0ZXIoSlNPTi5wYXJzZShtb2Nrcy5zdGFydFN0YXRlTWFjaGluZUlucHV0LmlucHV0ISkpO1xuICB9XG5cbiAgYXN5bmMgZnVuY3Rpb24gc2ltdWxhdGVXYWl0ZXIoZXZlbnQ6IEFXU0NES0FzeW5jQ3VzdG9tUmVzb3VyY2UuSXNDb21wbGV0ZVJlcXVlc3QpIHtcbiAgICBsZXQgcmV0cnkgPSB0cnVlO1xuICAgIGxldCBjb3VudCA9IDU7XG4gICAgd2hpbGUgKHJldHJ5KSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBmcmFtZXdvcmsuaXNDb21wbGV0ZShldmVudCk7XG4gICAgICAgIHJldHJ5ID0gZmFsc2U7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGlmIChlIGluc3RhbmNlb2YgY2ZuUmVzcG9uc2UuUmV0cnkpIHtcbiAgICAgICAgICBpZiAoY291bnQtLSA9PT0gMCkge1xuICAgICAgICAgICAgYXdhaXQgZnJhbWV3b3JrLm9uVGltZW91dCh7IENhdXNlOiBKU09OLnN0cmluZ2lmeSh7IGVycm9yTWVzc2FnZTogZS5tZXNzYWdlIH0pIH0pO1xuICAgICAgICAgICAgcmV0cnkgPSBmYWxzZTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0cnkgPSB0cnVlO1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBleHBlY3RDbG91ZEZvcm1hdGlvbkZhaWxlZChleHBlY3RlZFJlYXNvbjogc3RyaW5nLCByZXNwPzogUGFydGlhbDxBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVJlc3BvbnNlPikge1xuICBleHBlY3RDbG91ZEZvcm1hdGlvblJlc3BvbnNlKHtcbiAgICBTdGF0dXM6ICdGQUlMRUQnLFxuICAgIFJlYXNvbjogZXhwZWN0ZWRSZWFzb24sXG4gICAgLi4ucmVzcCxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGV4cGVjdENsb3VkRm9ybWF0aW9uU3VjY2VzcyhyZXNwPzogUGFydGlhbDxBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVJlc3BvbnNlPikge1xuICBpZiAobW9ja3MuY2ZuUmVzcG9uc2UuU3RhdHVzICE9PSAnU1VDQ0VTUycpIHtcbiAgICBjb25zb2xlLmVycm9yKG1vY2tzLmNmblJlc3BvbnNlLlJlYXNvbiB8fCAnPE5PIFJFQVNPTj4nKTtcbiAgfVxuXG4gIGV4cGVjdENsb3VkRm9ybWF0aW9uUmVzcG9uc2UoeyBTdGF0dXM6ICdTVUNDRVNTJywgLi4ucmVzcCB9KTtcbn1cblxuZnVuY3Rpb24gZXhwZWN0Q2xvdWRGb3JtYXRpb25SZXNwb25zZShyZXNwOiBQYXJ0aWFsPEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlUmVzcG9uc2U+ID0ge30pIHtcbiAgZm9yIChjb25zdCBba2V5LCBleHBlY3RlZF0gb2YgT2JqZWN0LmVudHJpZXMocmVzcCkpIHtcbiAgICBjb25zdCBhY3R1YWwgPSAobW9ja3MuY2ZuUmVzcG9uc2UgYXMgYW55KVtrZXldO1xuICAgIGV4cGVjdChhY3R1YWwpLnRvU3RyaWN0RXF1YWwoZXhwZWN0ZWQgYXMgYW55KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBleHBlY3ROb1dhaXRlcigpIHtcbiAgZXhwZWN0KG1vY2tzLnN0YXJ0U3RhdGVNYWNoaW5lSW5wdXQpLnRvQmVVbmRlZmluZWQoKTtcbn1cbiJdfQ==