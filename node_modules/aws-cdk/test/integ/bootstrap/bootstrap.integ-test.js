"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const core = require("@aws-cdk/core");
const fs = require("fs-extra");
const path = require("path");
const api_1 = require("../../../lib/api");
const bootstrap_1 = require("../../../lib/api/bootstrap");
const my_test_cdk_stack_1 = require("./example-cdk-app/my-test-cdk-stack");
jest.setTimeout(600000);
describe('Bootstrapping', () => {
    const bootstrapStackName = 'AwsCdkBootstrapIntegTestLegacy';
    const account = requireEnvVariable('TEST_ACCOUNT');
    const region = requireEnvVariable('TEST_REGION');
    let s3;
    let env;
    let sdkProvider;
    let sdk;
    beforeAll(async () => {
        env = {
            name: 'aws-cdk-bootstrap-integ-test',
            account,
            region,
        };
        sdkProvider = await api_1.SdkProvider.withAwsCliCompatibleDefaults({
            httpOptions: {
                userAgent: 'aws-cdk-bootstrap-integ-test',
            },
        });
        sdk = await sdkProvider.forEnvironment(env, api_1.Mode.ForWriting);
        s3 = sdk.s3();
    });
    describe('deploys the legacy bootstrap stack', () => {
        const legacyBootstrapBucketName = 'aws-cdk-bootstrap-integ-test-legacy-bckt';
        const newBootstrapBucketName = 'aws-cdk-bootstrap-integ-test-v2-bckt';
        const exampleAppStack = 'BootstrapIntegTestExampleCdkAppStack';
        const outdir = path.join(__dirname, 'cdk.out');
        let bootstrapStack;
        let testStack;
        beforeAll(async () => {
            // bootstrap the "old" way
            const bootstrapResults = await api_1.bootstrapEnvironment(env, sdkProvider, {
                toolkitStackName: bootstrapStackName,
                parameters: {
                    bucketName: legacyBootstrapBucketName,
                },
            });
            bootstrapStack = bootstrapResults.stackArtifact;
        });
        test('and then can deploy a CDK app using that bootstrap stack', async () => {
            testStack = await deployCdkApp(outdir, env, sdkProvider, sdk, bootstrapStackName, (app) => {
                new my_test_cdk_stack_1.MyTestCdkStack(app, exampleAppStack, {
                    assetType: my_test_cdk_stack_1.ExampleAsset.ASSET_1,
                    env,
                });
            });
        });
        describe('and then updates the bootstrap stack with the new resources', () => {
            beforeAll(async () => {
                // bootstrap the "new" way
                const bootstrapResults = await bootstrap_1.bootstrapEnvironment2(env, sdkProvider, {
                    toolkitStackName: bootstrapStackName,
                    parameters: {
                        bucketName: newBootstrapBucketName,
                        trustedAccounts: ['790124522186', '593667001225'],
                        cloudFormationExecutionPolicies: [
                            'arn:aws:iam::aws:policy/AdministratorAccess',
                            'arn:aws:iam::aws:policy/AmazonS3FullAccess',
                        ],
                    },
                });
                bootstrapStack = bootstrapResults.stackArtifact;
            });
            test('can now update the CDK app with the new bootstrap stack', async () => {
                await deployCdkApp(outdir, env, sdkProvider, sdk, bootstrapStackName, (app) => {
                    new my_test_cdk_stack_1.MyTestCdkStack(app, exampleAppStack, {
                        assetType: my_test_cdk_stack_1.ExampleAsset.ASSET_2,
                        env,
                    });
                });
            });
            afterAll(async () => {
                // empty and delete the now orphaned previous bootstrap bucket
                await emptyBucket(s3, legacyBootstrapBucketName);
                return s3.deleteBucket({ Bucket: legacyBootstrapBucketName }).promise();
            });
        });
        afterAll(() => {
            // delete the test CDK app stack
            return api_1.destroyStack({
                stack: testStack,
                sdk,
            });
        });
        afterAll(async () => {
            // empty the bootstrap bucket -
            // otherwise, CloudFormation will fail to delete the bootstrap stack
            await emptyBucket(s3, newBootstrapBucketName);
            return api_1.destroyStack({
                stack: bootstrapStack,
                sdk,
            });
        });
    });
});
function requireEnvVariable(variableName) {
    const ret = process.env[variableName];
    if (!ret) {
        throw new Error(`It is mandatory to set the '${variableName}' environment variable before running this test`);
    }
    return ret;
}
async function deployCdkApp(outdir, env, sdkProvider, sdk, bootstrapStackName, cdkCode) {
    // clean the output directory, just to make 100% sure there is no junk left there
    await fs.remove(outdir);
    // synthesize an app to a local cdk.out
    const app = new core.App({ outdir });
    cdkCode(app);
    const assembly = app.synth();
    // now deploy the synthesized app
    const toolkitInfo = await api_1.ToolkitInfo.lookup(env, sdk, bootstrapStackName);
    const testStack = assembly.stacks[0]; // we assume there's just one stack
    await api_1.deployStack({
        stack: testStack,
        resolvedEnvironment: env,
        toolkitInfo,
        sdkProvider,
        sdk,
    });
    return testStack;
}
async function emptyBucket(s3, bucketName) {
    const objects = await s3.listObjects({ Bucket: bucketName }).promise();
    const deletes = (objects.Contents || []).map(obj => obj.Key || '').filter(d => !!d);
    if (deletes.length === 0) {
        return Promise.resolve();
    }
    return s3.deleteObjects({
        Bucket: bucketName,
        Delete: {
            Objects: deletes.map(d => ({ Key: d })),
            Quiet: false,
        },
    }).promise();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9vdHN0cmFwLmludGVnLXRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJib290c3RyYXAuaW50ZWctdGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUFzQztBQUd0QywrQkFBK0I7QUFDL0IsNkJBQTZCO0FBQzdCLDBDQUF5SDtBQUN6SCwwREFBbUU7QUFDbkUsMkVBQW1GO0FBRW5GLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTyxDQUFDLENBQUM7QUFFekIsUUFBUSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7SUFDN0IsTUFBTSxrQkFBa0IsR0FBRyxnQ0FBZ0MsQ0FBQztJQUU1RCxNQUFNLE9BQU8sR0FBRyxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNuRCxNQUFNLE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNqRCxJQUFJLEVBQVUsQ0FBQztJQUNmLElBQUksR0FBc0IsQ0FBQztJQUMzQixJQUFJLFdBQXdCLENBQUM7SUFDN0IsSUFBSSxHQUFTLENBQUM7SUFFZCxTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkIsR0FBRyxHQUFHO1lBQ0osSUFBSSxFQUFFLDhCQUE4QjtZQUNwQyxPQUFPO1lBQ1AsTUFBTTtTQUNQLENBQUM7UUFDRixXQUFXLEdBQUcsTUFBTSxpQkFBVyxDQUFDLDRCQUE0QixDQUFDO1lBQzNELFdBQVcsRUFBRTtnQkFDWCxTQUFTLEVBQUUsOEJBQThCO2FBQzFDO1NBQ0YsQ0FBQyxDQUFDO1FBQ0gsR0FBRyxHQUFHLE1BQU0sV0FBVyxDQUFDLGNBQWMsQ0FBQyxHQUFHLEVBQUUsVUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzdELEVBQUUsR0FBRyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDaEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsb0NBQW9DLEVBQUUsR0FBRyxFQUFFO1FBQ2xELE1BQU0seUJBQXlCLEdBQUcsMENBQTBD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QUUsR0FBRztRQUN4QixXQUFXO1FBQ1gsV0FBVztRQUNYLEdBQUc7S0FDSixDQUFDLENBQUM7SUFDSCxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDO0FBRUQsS0FBSyxVQUFVLFdBQVcsQ0FBQyxFQUFVLEVBQUUsVUFBa0I7SUFDdkQsTUFBTSxPQUFPLEdBQUcsTUFBTSxFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDdkUsTUFBTSxPQUFPLEdBQUcsQ0FBQyxPQUFPLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3BGLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDeEIsT0FBTyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7S0FDMUI7SUFDRCxPQUFPLEVBQUUsQ0FBQyxhQUFhLENBQUM7UUFDdEIsTUFBTSxFQUFFLFVBQVU7UUFDbEIsTUFBTSxFQUFFO1lBQ04sT0FBTyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdkMsS0FBSyxFQUFFLEtBQUs7U0FDYjtLQUNGLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUNmLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjb3JlIGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0ICogYXMgY3hhcGkgZnJvbSAnQGF3cy1jZGsvY3gtYXBpJztcbmltcG9ydCAqIGFzIEFXUyBmcm9tICdhd3Mtc2RrJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBib290c3RyYXBFbnZpcm9ubWVudCwgZGVwbG95U3RhY2ssIGRlc3Ryb3lTdGFjaywgSVNESywgTW9kZSwgU2RrUHJvdmlkZXIsIFRvb2xraXRJbmZvIH0gZnJvbSAnLi4vLi4vLi4vbGliL2FwaSc7XG5pbXBvcnQgeyBib290c3RyYXBFbnZpcm9ubWVudDIgfSBmcm9tICcuLi8uLi8uLi9saWIvYXBpL2Jvb3RzdHJhcCc7XG5pbXBvcnQgeyBFeGFtcGxlQXNzZXQsIE15VGVzdENka1N0YWNrIH0gZnJvbSAnLi9leGFtcGxlLWNkay1hcHAvbXktdGVzdC1jZGstc3RhY2snO1xuXG5qZXN0LnNldFRpbWVvdXQoNjAwXzAwMCk7XG5cbmRlc2NyaWJlKCdCb290c3RyYXBwaW5nJywgKCkgPT4ge1xuICBjb25zdCBib290c3RyYXBTdGFja05hbWUgPSAnQXdzQ2RrQm9vdHN0cmFwSW50ZWdUZXN0TGVnYWN5JztcblxuICBjb25zdCBhY2NvdW50ID0gcmVxdWlyZUVudlZhcmlhYmxlKCdURVNUX0FDQ09VTlQnKTtcbiAgY29uc3QgcmVnaW9uID0gcmVxdWlyZUVudlZhcmlhYmxlKCdURVNUX1JFR0lPTicpO1xuICBsZXQgczM6IEFXUy5TMztcbiAgbGV0IGVudjogY3hhcGkuRW52aXJvbm1lbnQ7XG4gIGxldCBzZGtQcm92aWRlcjogU2RrUHJvdmlkZXI7XG4gIGxldCBzZGs6IElTREs7XG5cbiAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICBlbnYgPSB7XG4gICAgICBuYW1lOiAnYXdzLWNkay1ib290c3RyYXAtaW50ZWctdGVzdCcsXG4gICAgICBhY2NvdW50LFxuICAgICAgcmVnaW9uLFxuICAgIH07XG4gICAgc2RrUHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHtcbiAgICAgIGh0dHBPcHRpb25zOiB7XG4gICAgICAgIHVzZXJBZ2VudDogJ2F3cy1jZGstYm9vdHN0cmFwLWludGVnLXRlc3QnLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBzZGsgPSBhd2FpdCBzZGtQcm92aWRlci5mb3JFbnZpcm9ubWVudChlbnYsIE1vZGUuRm9yV3JpdGluZyk7XG4gICAgczMgPSBzZGsuczMoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2RlcGxveXMgdGhlIGxlZ2FjeSBib290c3RyYXAgc3RhY2snLCAoKSA9PiB7XG4gICAgY29uc3QgbGVnYWN5Qm9vdHN0cmFwQnVja2V0TmFtZSA9ICdhd3MtY2RrLWJvb3RzdHJhcC1pbnRlZy10ZXN0LWxlZ2FjeS1iY2t0JztcbiAgICBjb25zdCBuZXdCb290c3RyYXBCdWNrZXROYW1lID0gJ2F3cy1jZGstYm9vdHN0cmFwLWludGVnLXRlc3QtdjItYmNrdCc7XG4gICAgY29uc3QgZXhhbXBsZUFwcFN0YWNrID0gJ0Jvb3RzdHJhcEludGVnVGVzdEV4YW1wbGVDZGtBcHBTdGFjayc7XG4gICAgY29uc3Qgb3V0ZGlyID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ2Nkay5vdXQnKTtcblxuICAgIGxldCBib290c3RyYXBTdGFjazogY3hhcGkuQ2xvdWRGb3JtYXRpb25TdGFja0FydGlmYWN0O1xuICAgIGxldCB0ZXN0U3RhY2s6IGN4YXBpLkNsb3VkRm9ybWF0aW9uU3RhY2tBcnRpZmFjdDtcblxuICAgIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gICAgICAvLyBib290c3RyYXAgdGhlIFwib2xkXCIgd2F5XG4gICAgICBjb25zdCBib290c3RyYXBSZXN1bHRzID0gYXdhaXQgYm9vdHN0cmFwRW52aXJvbm1lbnQoZW52LCBzZGtQcm92aWRlciwge1xuICAgICAgICB0b29sa2l0U3RhY2tOYW1lOiBib290c3RyYXBTdGFja05hbWUsXG4gICAgICAgIHBhcmFtZXRlcnM6IHtcbiAgICAgICAgICBidWNrZXROYW1lOiBsZWdhY3lCb290c3RyYXBCdWNrZXROYW1lLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgICBib290c3RyYXBTdGFjayA9IGJvb3RzdHJhcFJlc3VsdHMuc3RhY2tBcnRpZmFjdDtcbiAgICB9KTtcblxuICAgIHRlc3QoJ2FuZCB0aGVuIGNhbiBkZXBsb3kgYSBDREsgYXBwIHVzaW5nIHRoYXQgYm9vdHN0cmFwIHN0YWNrJywgYXN5bmMgKCkgPT4ge1xuICAgICAgdGVzdFN0YWNrID0gYXdhaXQgZGVwbG95Q2RrQXBwKG91dGRpciwgZW52LCBzZGtQcm92aWRlciwgc2RrLCBib290c3RyYXBTdGFja05hbWUsIChhcHApID0+IHtcbiAgICAgICAgbmV3IE15VGVzdENka1N0YWNrKGFwcCwgZXhhbXBsZUFwcFN0YWNrLCB7XG4gICAgICAgICAgYXNzZXRUeXBlOiBFeGFtcGxlQXNzZXQuQVNTRVRfMSxcbiAgICAgICAgICBlbnYsXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnYW5kIHRoZW4gdXBkYXRlcyB0aGUgYm9vdHN0cmFwIHN0YWNrIHdpdGggdGhlIG5ldyByZXNvdXJjZXMnLCAoKSA9PiB7XG4gICAgICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgICAgICAvLyBib290c3RyYXAgdGhlIFwibmV3XCIgd2F5XG4gICAgICAgIGNvbnN0IGJvb3RzdHJhcFJlc3VsdHMgPSBhd2FpdCBib290c3RyYXBFbnZpcm9ubWVudDIoZW52LCBzZGtQcm92aWRlciwge1xuICAgICAgICAgIHRvb2xraXRTdGFja05hbWU6IGJvb3RzdHJhcFN0YWNrTmFtZSxcbiAgICAgICAgICBwYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgICBidWNrZXROYW1lOiBuZXdCb290c3RyYXBCdWNrZXROYW1lLFxuICAgICAgICAgICAgdHJ1c3RlZEFjY291bnRzOiBbJzc5MDEyNDUyMjE4NicsICc1OTM2NjcwMDEyMjUnXSxcbiAgICAgICAgICAgIGNsb3VkRm9ybWF0aW9uRXhlY3V0aW9uUG9saWNpZXM6IFtcbiAgICAgICAgICAgICAgJ2Fybjphd3M6aWFtOjphd3M6cG9saWN5L0FkbWluaXN0cmF0b3JBY2Nlc3MnLFxuICAgICAgICAgICAgICAnYXJuOmF3czppYW06OmF3czpwb2xpY3kvQW1hem9uUzNGdWxsQWNjZXNzJyxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIGJvb3RzdHJhcFN0YWNrID0gYm9vdHN0cmFwUmVzdWx0cy5zdGFja0FydGlmYWN0O1xuICAgICAgfSk7XG5cbiAgICAgIHRlc3QoJ2NhbiBub3cgdXBkYXRlIHRoZSBDREsgYXBwIHdpdGggdGhlIG5ldyBib290c3RyYXAgc3RhY2snLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGF3YWl0IGRlcGxveUNka0FwcChvdXRkaXIsIGVudiwgc2RrUHJvdmlkZXIsIHNkaywgYm9vdHN0cmFwU3RhY2tOYW1lLCAoYXBwKSA9PiB7XG4gICAgICAgICAgbmV3IE15VGVzdENka1N0YWNrKGFwcCwgZXhhbXBsZUFwcFN0YWNrLCB7XG4gICAgICAgICAgICBhc3NldFR5cGU6IEV4YW1wbGVBc3NldC5BU1NFVF8yLFxuICAgICAgICAgICAgZW52LFxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBhZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgICAgIC8vIGVtcHR5IGFuZCBkZWxldGUgdGhlIG5vdyBvcnBoYW5lZCBwcmV2aW91cyBib290c3RyYXAgYnVja2V0XG4gICAgICAgIGF3YWl0IGVtcHR5QnVja2V0KHMzLCBsZWdhY3lCb290c3RyYXBCdWNrZXROYW1lKTtcbiAgICAgICAgcmV0dXJuIHMzLmRlbGV0ZUJ1Y2tldCh7IEJ1Y2tldDogbGVnYWN5Qm9vdHN0cmFwQnVja2V0TmFtZSB9KS5wcm9taXNlKCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGFmdGVyQWxsKCgpID0+IHtcbiAgICAgIC8vIGRlbGV0ZSB0aGUgdGVzdCBDREsgYXBwIHN0YWNrXG4gICAgICByZXR1cm4gZGVzdHJveVN0YWNrKHtcbiAgICAgICAgc3RhY2s6IHRlc3RTdGFjayxcbiAgICAgICAgc2RrLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBhZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgICAvLyBlbXB0eSB0aGUgYm9vdHN0cmFwIGJ1Y2tldCAtXG4gICAgICAvLyBvdGhlcndpc2UsIENsb3VkRm9ybWF0aW9uIHdpbGwgZmFpbCB0byBkZWxldGUgdGhlIGJvb3RzdHJhcCBzdGFja1xuICAgICAgYXdhaXQgZW1wdHlCdWNrZXQoczMsIG5ld0Jvb3RzdHJhcEJ1Y2tldE5hbWUpO1xuXG4gICAgICByZXR1cm4gZGVzdHJveVN0YWNrKHtcbiAgICAgICAgc3RhY2s6IGJvb3RzdHJhcFN0YWNrLFxuICAgICAgICBzZGssXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59KTtcblxuZnVuY3Rpb24gcmVxdWlyZUVudlZhcmlhYmxlKHZhcmlhYmxlTmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgcmV0ID0gcHJvY2Vzcy5lbnZbdmFyaWFibGVOYW1lXTtcbiAgaWYgKCFyZXQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEl0IGlzIG1hbmRhdG9yeSB0byBzZXQgdGhlICcke3ZhcmlhYmxlTmFtZX0nIGVudmlyb25tZW50IHZhcmlhYmxlIGJlZm9yZSBydW5uaW5nIHRoaXMgdGVzdGApO1xuICB9XG4gIHJldHVybiByZXQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRlcGxveUNka0FwcChcbiAgb3V0ZGlyOiBzdHJpbmcsIGVudjogY3hhcGkuRW52aXJvbm1lbnQsIHNka1Byb3ZpZGVyOiBTZGtQcm92aWRlcixcbiAgc2RrOiBJU0RLLCBib290c3RyYXBTdGFja05hbWU6IHN0cmluZywgY2RrQ29kZTogKGFwcDogY29yZS5BcHApID0+IHZvaWQpIHtcbiAgLy8gY2xlYW4gdGhlIG91dHB1dCBkaXJlY3RvcnksIGp1c3QgdG8gbWFrZSAxMDAlIHN1cmUgdGhlcmUgaXMgbm8ganVuayBsZWZ0IHRoZXJlXG4gIGF3YWl0IGZzLnJlbW92ZShvdXRkaXIpO1xuXG4gIC8vIHN5bnRoZXNpemUgYW4gYXBwIHRvIGEgbG9jYWwgY2RrLm91dFxuICBjb25zdCBhcHAgPSBuZXcgY29yZS5BcHAoeyBvdXRkaXIgfSk7XG4gIGNka0NvZGUoYXBwKTtcbiAgY29uc3QgYXNzZW1ibHkgPSBhcHAuc3ludGgoKTtcblxuICAvLyBub3cgZGVwbG95IHRoZSBzeW50aGVzaXplZCBhcHBcbiAgY29uc3QgdG9vbGtpdEluZm8gPSBhd2FpdCBUb29sa2l0SW5mby5sb29rdXAoZW52LCBzZGssIGJvb3RzdHJhcFN0YWNrTmFtZSk7XG4gIGNvbnN0IHRlc3RTdGFjayA9IGFzc2VtYmx5LnN0YWNrc1swXTsgLy8gd2UgYXNzdW1lIHRoZXJlJ3MganVzdCBvbmUgc3RhY2tcbiAgYXdhaXQgZGVwbG95U3RhY2soe1xuICAgIHN0YWNrOiB0ZXN0U3RhY2ssXG4gICAgcmVzb2x2ZWRFbnZpcm9ubWVudDogZW52LFxuICAgIHRvb2xraXRJbmZvLFxuICAgIHNka1Byb3ZpZGVyLFxuICAgIHNkayxcbiAgfSk7XG4gIHJldHVybiB0ZXN0U3RhY2s7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGVtcHR5QnVja2V0KHMzOiBBV1MuUzMsIGJ1Y2tldE5hbWU6IHN0cmluZykge1xuICBjb25zdCBvYmplY3RzID0gYXdhaXQgczMubGlzdE9iamVjdHMoeyBCdWNrZXQ6IGJ1Y2tldE5hbWUgfSkucHJvbWlzZSgpO1xuICBjb25zdCBkZWxldGVzID0gKG9iamVjdHMuQ29udGVudHMgfHwgW10pLm1hcChvYmogPT4gb2JqLktleSB8fCAnJykuZmlsdGVyKGQgPT4gISFkKTtcbiAgaWYgKGRlbGV0ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG4gIHJldHVybiBzMy5kZWxldGVPYmplY3RzKHtcbiAgICBCdWNrZXQ6IGJ1Y2tldE5hbWUsXG4gICAgRGVsZXRlOiB7XG4gICAgICBPYmplY3RzOiBkZWxldGVzLm1hcChkID0+ICh7IEtleTogZCB9KSksXG4gICAgICBRdWlldDogZmFsc2UsXG4gICAgfSxcbiAgfSkucHJvbWlzZSgpO1xufVxuIl19